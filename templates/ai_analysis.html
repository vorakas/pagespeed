<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Analysis - PageSpeed Insights Monitor</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <!-- Side Navigation -->
    <nav class="side-nav">
        <div class="side-nav-header">
            <h2>Menu</h2>
        </div>
        <ul class="side-nav-list">
            <li><a href="/" class="side-nav-link"><span class="nav-icon"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg></span>Dashboard</a></li>
            <li><a href="/setup" class="side-nav-link"><span class="nav-icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></span>Site/URL Setup</a></li>
            <li><a href="/test" class="side-nav-link"><span class="nav-icon"><svg viewBox="0 0 24 24"><polyline points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg></span>Test URLs</a></li>
            <li><a href="/metrics" class="side-nav-link"><span class="nav-icon"><svg viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg></span>Page Performance Metrics</a></li>
            <li><a href="/newrelic" class="side-nav-link"><span class="nav-icon"><svg viewBox="0 0 24 24"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg></span>New Relic Metrics</a></li>
            <li><a href="/iislogs" class="side-nav-link"><span class="nav-icon"><svg viewBox="0 0 24 24"><rect x="2" y="2" width="20" height="8" rx="2" ry="2"/><rect x="2" y="14" width="20" height="8" rx="2" ry="2"/><line x1="6" y1="6" x2="6.01" y2="6"/><line x1="6" y1="18" x2="6.01" y2="18"/></svg></span>IIS Logs</a></li>
            <li><a href="/ai-analysis" class="side-nav-link active"><span class="nav-icon"><svg viewBox="0 0 24 24"><path d="M12 2a4 4 0 0 1 4 4v1h1a3 3 0 0 1 3 3v1a3 3 0 0 1-3 3h-1v1a4 4 0 0 1-8 0v-1H7a3 3 0 0 1-3-3v-1a3 3 0 0 1 3-3h1V6a4 4 0 0 1 4-4z"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/><path d="M9.5 13a3.5 3.5 0 0 0 5 0"/></svg></span>AI Analysis</a></li>
        </ul>
    </nav>

    <!-- Main Content Area -->
    <div class="main-content">
        <header>
            <div class="header-content">
                <div class="header-text">
                    <h1>
                        <img src="{{ url_for('static', filename='images/DarkModeLogo.png') }}" alt="Lamps Plus" class="header-logo header-logo-dark">
                        <img src="{{ url_for('static', filename='images/LightModeLogo.png') }}" alt="Lamps Plus" class="header-logo header-logo-light">
                        PageSpeed Insights Monitor
                    </h1>
                    <p>AI-Powered Performance Analysis</p>
                </div>
                <button id="themeToggle" class="theme-toggle" onclick="toggleTheme()">
                    <span class="theme-icon">&#9728;&#65039;</span>
                    <span class="theme-label">Light Mode</span>
                </button>
            </div>
        </header>

        <!-- AI API Configuration Section -->
        <section class="ai-config-section">
            <h2>AI API Configuration</h2>
            <div class="config-grid">
                <div class="config-card">
                    <h3>Claude (Anthropic)</h3>
                    <div class="form-group">
                        <label for="claudeApiKey">API Key</label>
                        <input type="password" id="claudeApiKey" placeholder="sk-ant-api03-...">
                    </div>
                    <div class="form-group">
                        <label for="claudeModel">Model</label>
                        <select id="claudeModel">
                            <option value="claude-sonnet-4-20250514" selected>Claude Sonnet 4</option>
                            <option value="claude-opus-4-20250514">Claude Opus 4</option>
                        </select>
                    </div>
                </div>
                <div class="config-card">
                    <h3>OpenAI</h3>
                    <div class="form-group">
                        <label for="openaiApiKey">API Key</label>
                        <input type="password" id="openaiApiKey" placeholder="sk-...">
                    </div>
                    <div class="form-group">
                        <label for="openaiModel">Model</label>
                        <select id="openaiModel">
                            <option value="gpt-4o" selected>GPT-4o</option>
                            <option value="gpt-4o-mini">GPT-4o Mini</option>
                        </select>
                    </div>
                </div>
            </div>
            <button onclick="saveAiConfig()" class="btn-primary" style="width: auto; margin-top: 10px;">Save AI Configuration</button>
            <div id="aiConfigStatus" class="connection-status" style="display: none;"></div>
        </section>

        <!-- Analysis Input Section -->
        <section class="ai-input-section">
            <h2>Performance Analysis</h2>

            <div class="ai-disclaimer">
                <strong>Experimental Feature:</strong> AI-generated analysis is provided for informational purposes only. Results may contain inaccuracies and should always be verified by a qualified person before making decisions.
                <br><br>
                <strong>Note:</strong> This feature is currently only available for the Lamps Plus site. Adobe Commerce site analysis is not yet supported as the New Relic implementation has not been completed.
            </div>

            <!-- Data source status badges -->
            <div id="dataSourceStatus" class="ai-data-sources" style="display: none;">
                <span id="nrStatus" class="data-source-badge"></span>
                <span id="azureStatus" class="data-source-badge"></span>
            </div>

            <!-- URL inputs (full width, stacked) -->
            <div class="ai-url-inputs">
                <div class="form-group">
                    <label for="aiUrlPath">URL Path to Analyze (for IIS Logs)</label>
                    <input type="text" id="aiUrlPath" placeholder="/products/ceiling-fans">
                </div>
                <div class="form-group">
                    <label for="aiPageUrl">Full Page URL (for Core Web Vitals)</label>
                    <input type="text" id="aiPageUrl" placeholder="https://www.lampsplus.com/products/ceiling-fans/">
                </div>
            </div>

            <!-- Options row -->
            <div class="ai-input-grid">
                <div class="form-group">
                    <label for="aiTimeRange">Time Range</label>
                    <select id="aiTimeRange">
                        <option value="30 minutes ago">Last 30 minutes</option>
                        <option value="1 hour ago" selected>Last 1 hour</option>
                        <option value="3 hours ago">Last 3 hours</option>
                        <option value="6 hours ago">Last 6 hours</option>
                        <option value="12 hours ago">Last 12 hours</option>
                        <option value="24 hours ago">Last 24 hours</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="aiSiteFilter">IIS Site</label>
                    <select id="aiSiteFilter">
                        <option value="">All Sites</option>
                    </select>
                    <span id="aiSiteLoading" class="site-loading" style="display: none;">Loading sites...</span>
                </div>
                <div class="form-group">
                    <label>AI Providers</label>
                    <div class="provider-checkboxes">
                        <label class="checkbox-label">
                            <input type="checkbox" id="useClaude" checked> Claude
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="useOpenai" checked> OpenAI
                        </label>
                    </div>
                </div>
                <div class="form-group" style="align-self: end;">
                    <button onclick="runAnalysis()" class="btn-primary" id="analyzeBtn">Analyze</button>
                </div>
            </div>
        </section>

        <!-- Loading Indicator -->
        <div id="aiLoadingIndicator" class="loading-indicator" style="display: none;">
            <div class="loading-spinner"></div>
            <p id="aiLoadingText">Gathering performance data and running AI analysis...</p>
        </div>

        <!-- Results Section: Side by Side -->
        <div id="aiResultsSection" class="ai-results-section" style="display: none;">
            <h2>Analysis Results</h2>
            <div class="ai-results-grid" id="aiResultsGrid">
                <!-- Claude Results -->
                <div class="ai-result-panel" id="claudePanel" style="display: none;">
                    <div class="ai-result-header claude-header">
                        <h3>Claude Analysis</h3>
                        <span class="ai-model-badge" id="claudeModelBadge"></span>
                    </div>
                    <div class="ai-result-body" id="claudeResult"></div>
                    <div class="ai-result-footer" id="claudeFooter"></div>
                </div>

                <!-- OpenAI Results -->
                <div class="ai-result-panel" id="openaiPanel" style="display: none;">
                    <div class="ai-result-header openai-header">
                        <h3>OpenAI Analysis</h3>
                        <span class="ai-model-badge" id="openaiModelBadge"></span>
                    </div>
                    <div class="ai-result-body" id="openaiResult"></div>
                    <div class="ai-result-footer" id="openaiFooter"></div>
                </div>
            </div>

            <!-- Follow-up Question Input -->
            <div class="ai-followup-section" id="followupSection" style="display: none;">
                <div class="ai-followup-input-row">
                    <textarea id="followupInput"
                              class="ai-followup-textarea"
                              placeholder="Ask a follow-up question about the analysis..."
                              rows="2"></textarea>
                    <button onclick="sendFollowup()" class="btn-primary ai-followup-btn" id="followupBtn">
                        Ask Follow-up
                    </button>
                </div>
                <div id="followupLoading" class="ai-followup-loading" style="display: none;">
                    <div class="loading-spinner" style="width: 24px; height: 24px; border-width: 3px;"></div>
                    <span>Sending follow-up...</span>
                </div>
            </div>

            <!-- Prompt Preview (collapsible) -->
            <details class="ai-prompt-preview">
                <summary>View Data Sent to AI</summary>
                <pre id="promptPreview"></pre>
            </details>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script>
        // ==================== AI Config Management ====================

        let aiConfig = {
            claudeApiKey: null,
            claudeModel: 'claude-sonnet-4-20250514',
            openaiApiKey: null,
            openaiModel: 'gpt-4o'
        };

        function saveAiConfig() {
            aiConfig.claudeApiKey = document.getElementById('claudeApiKey').value.trim();
            aiConfig.claudeModel = document.getElementById('claudeModel').value;
            aiConfig.openaiApiKey = document.getElementById('openaiApiKey').value.trim();
            aiConfig.openaiModel = document.getElementById('openaiModel').value;

            localStorage.setItem('aiConfig', JSON.stringify(aiConfig));

            const status = document.getElementById('aiConfigStatus');
            status.style.display = 'block';
            status.className = 'connection-status success';
            status.textContent = 'AI configuration saved.';
            setTimeout(() => { status.style.display = 'none'; }, 3000);
        }

        function loadAiConfig() {
            const saved = localStorage.getItem('aiConfig');
            if (saved) {
                try {
                    aiConfig = JSON.parse(saved);
                    document.getElementById('claudeApiKey').value = aiConfig.claudeApiKey || '';
                    document.getElementById('claudeModel').value = aiConfig.claudeModel || 'claude-sonnet-4-20250514';
                    document.getElementById('openaiApiKey').value = aiConfig.openaiApiKey || '';
                    document.getElementById('openaiModel').value = aiConfig.openaiModel || 'gpt-4o';
                } catch (e) {
                    console.error('Error loading AI config:', e);
                }
            }
        }

        // ==================== Load NR & Azure configs from their pages ====================

        function getNrConfig() {
            try {
                return JSON.parse(localStorage.getItem('nrConfig')) || {};
            } catch (e) { return {}; }
        }

        function getAzureConfig() {
            try {
                return JSON.parse(localStorage.getItem('azureConfig')) || {};
            } catch (e) { return {}; }
        }

        // ==================== IIS Site Selector ====================

        async function loadAiSiteList() {
            const azConfig = getAzureConfig();
            if (!azConfig.tenantId || !azConfig.clientId || !azConfig.clientSecret || !azConfig.workspaceId) {
                return; // Azure not configured, skip loading sites
            }

            const indicator = document.getElementById('aiSiteLoading');
            indicator.style.display = 'inline';

            try {
                const response = await fetch('/api/azure/list-sites', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tenant_id: azConfig.tenantId,
                        client_id: azConfig.clientId,
                        client_secret: azConfig.clientSecret,
                        workspace_id: azConfig.workspaceId
                    })
                });

                const data = await response.json();
                indicator.style.display = 'none';

                if (data.success && data.sites && data.sites.length > 0) {
                    const select = document.getElementById('aiSiteFilter');
                    select.innerHTML = '<option value="">All Sites</option>';
                    data.sites.forEach(site => {
                        const opt = document.createElement('option');
                        opt.value = site;
                        opt.textContent = site;
                        select.appendChild(opt);
                    });

                    // Restore previously selected site from IIS Logs page config
                    if (azConfig.selectedSite) {
                        select.value = azConfig.selectedSite;
                    }
                }
            } catch (error) {
                indicator.style.display = 'none';
                console.error('Error loading site list:', error);
            }
        }

        // ==================== Conversation State ====================

        let conversationState = {
            active: false,
            systemPrompt: null,
            providers: [],
            claudeHistory: [],
            openaiHistory: [],
            claudeTotalUsage: { input_tokens: 0, output_tokens: 0 },
            openaiTotalUsage: { prompt_tokens: 0, completion_tokens: 0 },
            turnCount: 0
        };

        function resetConversation() {
            conversationState = {
                active: false,
                systemPrompt: null,
                providers: [],
                claudeHistory: [],
                openaiHistory: [],
                claudeTotalUsage: { input_tokens: 0, output_tokens: 0 },
                openaiTotalUsage: { prompt_tokens: 0, completion_tokens: 0 },
                turnCount: 0
            };
        }

        // ==================== Run Analysis ====================

        async function runAnalysis() {
            // Reset any previous conversation
            resetConversation();
            document.getElementById('followupSection').style.display = 'none';

            const urlPath = document.getElementById('aiUrlPath').value.trim();
            const pageUrl = document.getElementById('aiPageUrl').value.trim();
            const timeRange = document.getElementById('aiTimeRange').value;
            const useClaude = document.getElementById('useClaude').checked;
            const useOpenai = document.getElementById('useOpenai').checked;

            if (!urlPath) {
                showToast('Please enter a URL path to analyze.', 'warning');
                return;
            }

            if (!useClaude && !useOpenai) {
                showToast('Please select at least one AI provider.', 'warning');
                return;
            }

            // Validate API keys for selected providers
            if (useClaude && !aiConfig.claudeApiKey) {
                showToast('Please configure your Claude API key first.', 'warning');
                return;
            }
            if (useOpenai && !aiConfig.openaiApiKey) {
                showToast('Please configure your OpenAI API key first.', 'warning');
                return;
            }

            const nrConfig = getNrConfig();
            const azConfig = getAzureConfig();

            // Build request payload
            const providers = [];
            if (useClaude) providers.push('claude');
            if (useOpenai) providers.push('openai');

            const payload = {
                url: urlPath,
                page_url: pageUrl || null,
                time_range: timeRange,
                providers: providers,
                // NR credentials (from NR page localStorage)
                nr_api_key: nrConfig.apiKey || null,
                nr_account_id: nrConfig.accountId || null,
                nr_app_name: nrConfig.appName || null,
                // Azure credentials (from IIS page localStorage)
                azure_tenant_id: azConfig.tenantId || null,
                azure_client_id: azConfig.clientId || null,
                azure_client_secret: azConfig.clientSecret || null,
                azure_workspace_id: azConfig.workspaceId || null,
                azure_site_name: document.getElementById('aiSiteFilter').value || null,
                // AI keys
                claude_api_key: useClaude ? aiConfig.claudeApiKey : null,
                claude_model: aiConfig.claudeModel,
                openai_api_key: useOpenai ? aiConfig.openaiApiKey : null,
                openai_model: aiConfig.openaiModel
            };

            // Show loading
            document.getElementById('aiLoadingIndicator').style.display = 'flex';
            document.getElementById('aiResultsSection').style.display = 'none';
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('analyzeBtn').textContent = 'Analyzing...';

            try {
                const response = await fetch('/api/ai/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                document.getElementById('aiLoadingIndicator').style.display = 'none';
                document.getElementById('analyzeBtn').disabled = false;
                document.getElementById('analyzeBtn').textContent = 'Analyze';

                if (!response.ok || !data.success) {
                    showToast('Analysis failed: ' + (data.error || 'Unknown error'), 'error');
                    return;
                }

                displayResults(data);

                // Initialize conversation state for follow-ups
                conversationState.active = true;
                conversationState.systemPrompt = data.system_prompt;
                conversationState.providers = providers;
                conversationState.turnCount = 1;

                if (data.claude && data.claude.success) {
                    conversationState.claudeHistory = [
                        { role: 'user', content: data.user_message },
                        { role: 'assistant', content: data.claude.analysis }
                    ];
                    conversationState.claudeTotalUsage = { ...data.claude.usage };
                }

                if (data.openai && data.openai.success) {
                    conversationState.openaiHistory = [
                        { role: 'user', content: data.user_message },
                        { role: 'assistant', content: data.openai.analysis }
                    ];
                    conversationState.openaiTotalUsage = { ...data.openai.usage };
                }

                // Show follow-up section
                document.getElementById('followupSection').style.display = 'block';

            } catch (error) {
                document.getElementById('aiLoadingIndicator').style.display = 'none';
                document.getElementById('analyzeBtn').disabled = false;
                document.getElementById('analyzeBtn').textContent = 'Analyze';
                showToast('Error running analysis: ' + error.message, 'error');
            }
        }

        // ==================== Display Results ====================

        function displayResults(data) {
            document.getElementById('aiResultsSection').style.display = 'block';

            // Update data source badges
            document.getElementById('nrStatus').textContent =
                data.data_sources.newrelic ? 'New Relic: Connected' : 'New Relic: No data';
            document.getElementById('nrStatus').className =
                'data-source-badge ' + (data.data_sources.newrelic ? 'badge-success' : 'badge-warning');
            document.getElementById('azureStatus').textContent =
                data.data_sources.iis_logs ? 'IIS Logs: Connected' : 'IIS Logs: No data';
            document.getElementById('azureStatus').className =
                'data-source-badge ' + (data.data_sources.iis_logs ? 'badge-success' : 'badge-warning');

            // Claude panel
            const claudePanel = document.getElementById('claudePanel');
            if (data.claude) {
                claudePanel.style.display = 'block';
                if (data.claude.success) {
                    document.getElementById('claudeResult').innerHTML =
                        '<div class="ai-message ai-message-assistant">' +
                        '<div class="ai-message-label">Initial Analysis</div>' +
                        '<div class="ai-message-content">' + marked.parse(data.claude.analysis) + '</div>' +
                        '</div>';
                    document.getElementById('claudeModelBadge').textContent = data.claude.model;
                    if (data.claude.usage) {
                        document.getElementById('claudeFooter').textContent =
                            `Tokens: ${data.claude.usage.input_tokens.toLocaleString()} in / ${data.claude.usage.output_tokens.toLocaleString()} out`;
                    }
                } else {
                    document.getElementById('claudeResult').innerHTML =
                        '<div class="ai-error">' + escapeHtml(data.claude.error) + '</div>';
                    document.getElementById('claudeModelBadge').textContent = '';
                    document.getElementById('claudeFooter').textContent = '';
                }
            } else {
                claudePanel.style.display = 'none';
            }

            // OpenAI panel
            const openaiPanel = document.getElementById('openaiPanel');
            if (data.openai) {
                openaiPanel.style.display = 'block';
                if (data.openai.success) {
                    document.getElementById('openaiResult').innerHTML =
                        '<div class="ai-message ai-message-assistant">' +
                        '<div class="ai-message-label">Initial Analysis</div>' +
                        '<div class="ai-message-content">' + marked.parse(data.openai.analysis) + '</div>' +
                        '</div>';
                    document.getElementById('openaiModelBadge').textContent = data.openai.model;
                    if (data.openai.usage) {
                        document.getElementById('openaiFooter').textContent =
                            `Tokens: ${data.openai.usage.prompt_tokens.toLocaleString()} in / ${data.openai.usage.completion_tokens.toLocaleString()} out`;
                    }
                } else {
                    document.getElementById('openaiResult').innerHTML =
                        '<div class="ai-error">' + escapeHtml(data.openai.error) + '</div>';
                    document.getElementById('openaiModelBadge').textContent = '';
                    document.getElementById('openaiFooter').textContent = '';
                }
            } else {
                openaiPanel.style.display = 'none';
            }

            // Prompt preview
            document.getElementById('promptPreview').textContent = data.prompt_preview || '';

            // Scroll to results
            document.getElementById('aiResultsSection').scrollIntoView({ behavior: 'smooth' });
        }

        // ==================== Follow-up Functions ====================

        async function sendFollowup() {
            const followupInput = document.getElementById('followupInput');
            const question = followupInput.value.trim();

            if (!question) {
                showToast('Please enter a follow-up question.', 'warning');
                return;
            }

            if (!conversationState.active) {
                showToast('No active analysis. Please run an initial analysis first.', 'warning');
                return;
            }

            // Append user question to histories
            if (conversationState.claudeHistory.length > 0) {
                conversationState.claudeHistory.push({ role: 'user', content: question });
            }
            if (conversationState.openaiHistory.length > 0) {
                conversationState.openaiHistory.push({ role: 'user', content: question });
            }

            // Show user question in panels immediately
            appendUserMessage(question);

            // Disable input, show loading
            followupInput.value = '';
            followupInput.disabled = true;
            document.getElementById('followupBtn').disabled = true;
            document.getElementById('followupBtn').textContent = 'Sending...';
            document.getElementById('followupLoading').style.display = 'flex';

            // Build payload
            const payload = {
                providers: conversationState.providers,
                system_prompt: conversationState.systemPrompt,
                claude_api_key: aiConfig.claudeApiKey,
                claude_model: aiConfig.claudeModel,
                openai_api_key: aiConfig.openaiApiKey,
                openai_model: aiConfig.openaiModel,
                claude_history: conversationState.claudeHistory.length > 0 ? conversationState.claudeHistory : null,
                openai_history: conversationState.openaiHistory.length > 0 ? conversationState.openaiHistory : null
            };

            try {
                const response = await fetch('/api/ai/follow-up', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                // Re-enable input
                followupInput.disabled = false;
                document.getElementById('followupBtn').disabled = false;
                document.getElementById('followupBtn').textContent = 'Ask Follow-up';
                document.getElementById('followupLoading').style.display = 'none';

                if (!response.ok || !data.success) {
                    // Rollback user message from histories
                    if (conversationState.claudeHistory.length > 0) {
                        conversationState.claudeHistory.pop();
                    }
                    if (conversationState.openaiHistory.length > 0) {
                        conversationState.openaiHistory.pop();
                    }
                    showToast('Follow-up failed: ' + (data.error || 'Unknown error'), 'error');
                    return;
                }

                appendFollowupResults(data);

            } catch (error) {
                followupInput.disabled = false;
                document.getElementById('followupBtn').disabled = false;
                document.getElementById('followupBtn').textContent = 'Ask Follow-up';
                document.getElementById('followupLoading').style.display = 'none';

                // Rollback history
                if (conversationState.claudeHistory.length > 0) {
                    conversationState.claudeHistory.pop();
                }
                if (conversationState.openaiHistory.length > 0) {
                    conversationState.openaiHistory.pop();
                }
                showToast('Error sending follow-up: ' + error.message, 'error');
            }
        }

        function appendUserMessage(question) {
            // Append to Claude panel if active
            const claudeBody = document.getElementById('claudeResult');
            if (claudeBody && document.getElementById('claudePanel').style.display !== 'none') {
                const msgDiv = document.createElement('div');
                msgDiv.className = 'ai-message ai-message-user';
                msgDiv.innerHTML = '<div class="ai-message-label">You</div>' +
                    '<div class="ai-message-content">' + escapeHtml(question) + '</div>';
                claudeBody.appendChild(msgDiv);
                claudeBody.scrollTop = claudeBody.scrollHeight;
            }

            // Append to OpenAI panel if active
            const openaiBody = document.getElementById('openaiResult');
            if (openaiBody && document.getElementById('openaiPanel').style.display !== 'none') {
                const msgDiv = document.createElement('div');
                msgDiv.className = 'ai-message ai-message-user';
                msgDiv.innerHTML = '<div class="ai-message-label">You</div>' +
                    '<div class="ai-message-content">' + escapeHtml(question) + '</div>';
                openaiBody.appendChild(msgDiv);
                openaiBody.scrollTop = openaiBody.scrollHeight;
            }
        }

        function appendFollowupResults(data) {
            conversationState.turnCount++;
            const followupNum = conversationState.turnCount - 1;

            // Claude response
            if (data.claude) {
                const claudeBody = document.getElementById('claudeResult');
                if (data.claude.success) {
                    conversationState.claudeHistory.push({
                        role: 'assistant',
                        content: data.claude.analysis
                    });

                    const msgDiv = document.createElement('div');
                    msgDiv.className = 'ai-message ai-message-assistant';
                    msgDiv.innerHTML =
                        '<div class="ai-message-label">Claude (Follow-up #' + followupNum + ')</div>' +
                        '<div class="ai-message-content">' + marked.parse(data.claude.analysis) + '</div>';
                    claudeBody.appendChild(msgDiv);

                    // Update cumulative token usage
                    if (data.claude.usage) {
                        conversationState.claudeTotalUsage.input_tokens += data.claude.usage.input_tokens;
                        conversationState.claudeTotalUsage.output_tokens += data.claude.usage.output_tokens;
                    }
                    const ct = conversationState.claudeTotalUsage;
                    document.getElementById('claudeFooter').innerHTML =
                        `Tokens: ${ct.input_tokens.toLocaleString()} in / ${ct.output_tokens.toLocaleString()} out ` +
                        `<span class="ai-turn-count">(${conversationState.turnCount} turns)</span>`;

                    claudeBody.scrollTop = claudeBody.scrollHeight;
                } else {
                    const errDiv = document.createElement('div');
                    errDiv.className = 'ai-error';
                    errDiv.textContent = data.claude.error;
                    claudeBody.appendChild(errDiv);
                    claudeBody.scrollTop = claudeBody.scrollHeight;
                }
            }

            // OpenAI response
            if (data.openai) {
                const openaiBody = document.getElementById('openaiResult');
                if (data.openai.success) {
                    conversationState.openaiHistory.push({
                        role: 'assistant',
                        content: data.openai.analysis
                    });

                    const msgDiv = document.createElement('div');
                    msgDiv.className = 'ai-message ai-message-assistant';
                    msgDiv.innerHTML =
                        '<div class="ai-message-label">OpenAI (Follow-up #' + followupNum + ')</div>' +
                        '<div class="ai-message-content">' + marked.parse(data.openai.analysis) + '</div>';
                    openaiBody.appendChild(msgDiv);

                    // Update cumulative token usage
                    if (data.openai.usage) {
                        conversationState.openaiTotalUsage.prompt_tokens += data.openai.usage.prompt_tokens;
                        conversationState.openaiTotalUsage.completion_tokens += data.openai.usage.completion_tokens;
                    }
                    const ot = conversationState.openaiTotalUsage;
                    document.getElementById('openaiFooter').innerHTML =
                        `Tokens: ${ot.prompt_tokens.toLocaleString()} in / ${ot.completion_tokens.toLocaleString()} out ` +
                        `<span class="ai-turn-count">(${conversationState.turnCount} turns)</span>`;

                    openaiBody.scrollTop = openaiBody.scrollHeight;
                } else {
                    const errDiv = document.createElement('div');
                    errDiv.className = 'ai-error';
                    errDiv.textContent = data.openai.error;
                    openaiBody.appendChild(errDiv);
                    openaiBody.scrollTop = openaiBody.scrollHeight;
                }
            }

            // Scroll follow-up input into view
            document.getElementById('followupSection').scrollIntoView({ behavior: 'smooth' });
        }

        // Helper: escape HTML
        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // ==================== Initialize ====================

        document.addEventListener('DOMContentLoaded', function() {
            loadAiConfig();
            loadAiSiteList();

            // Show data source status badges
            const nrConfig = getNrConfig();
            const azConfig = getAzureConfig();

            const dsStatus = document.getElementById('dataSourceStatus');
            dsStatus.style.display = 'flex';
            document.getElementById('nrStatus').textContent =
                nrConfig.apiKey ? 'New Relic: Configured' : 'New Relic: Not configured';
            document.getElementById('nrStatus').className =
                'data-source-badge ' + (nrConfig.apiKey ? 'badge-success' : 'badge-warning');
            document.getElementById('azureStatus').textContent =
                azConfig.tenantId ? 'Azure IIS: Configured' : 'Azure IIS: Not configured';
            document.getElementById('azureStatus').className =
                'data-source-badge ' + (azConfig.tenantId ? 'badge-success' : 'badge-warning');

            // Enter key submits follow-up (Shift+Enter for newlines)
            document.getElementById('followupInput').addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendFollowup();
                }
            });
        });
    </script>
</body>
</html>
