<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Relic Metrics - PageSpeed Insights Monitor</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <!-- Side Navigation -->
    <nav class="side-nav">
        <div class="side-nav-header">
            <h2>Menu</h2>
        </div>
        <ul class="side-nav-list">
            <li><a href="/" class="side-nav-link">‚Üê Back</a></li>
            <li><a href="/setup" class="side-nav-link">Site/URL Setup</a></li>
            <li><a href="/test" class="side-nav-link">Test URLs</a></li>
            <li><a href="/metrics" class="side-nav-link">Page Performance Metrics</a></li>
            <li><a href="/newrelic" class="side-nav-link active">New Relic Metrics</a></li>
            <li><a href="/iislogs" class="side-nav-link">IIS Logs</a></li>
        </ul>
    </nav>

    <!-- Main Content Area -->
    <div class="main-content">
        <header>
            <div class="header-content">
                <div class="header-text">
                    <h1>
                        <img src="{{ url_for('static', filename='images/DarkModeLogo.png') }}" alt="Lamps Plus" class="header-logo header-logo-dark">
                        <img src="{{ url_for('static', filename='images/LightModeLogo.png') }}" alt="Lamps Plus" class="header-logo header-logo-light">
                        PageSpeed Insights Monitor
                    </h1>
                    <p>New Relic Application Performance Monitoring</p>
                </div>
                <button id="themeToggle" class="theme-toggle" onclick="toggleTheme()">
                    <span class="theme-icon">‚òÄÔ∏è</span>
                    <span class="theme-label">Light Mode</span>
                </button>
            </div>
        </header>

        <!-- Configuration Section -->
        <section class="newrelic-config-section">
            <h2>üîß New Relic Configuration</h2>
            <div class="config-grid">
                <div class="config-card">
                    <h3>API Configuration</h3>
                    <div class="form-group">
                        <label for="nrApiKey">API Key</label>
                        <input type="password" id="nrApiKey" placeholder="Enter your New Relic API key">
                    </div>
                    <div class="form-group">
                        <label for="nrAccountId">Account ID</label>
                        <input type="text" id="nrAccountId" placeholder="Enter your Account ID">
                    </div>
                    <button onclick="saveNewRelicConfig()" class="btn-primary">Save Configuration</button>
                </div>
                <div class="config-card">
                    <h3>Application Settings</h3>
                    <div class="form-group">
                        <label for="nrAppName">Application Name</label>
                        <input type="text" id="nrAppName" placeholder="Enter your Application Name (e.g., 'Production Web App')">
                    </div>
                    <div class="form-group">
                        <label for="nrRefreshRate">Refresh Rate (seconds)</label>
                        <select id="nrRefreshRate">
                            <option value="30">30 seconds</option>
                            <option value="60" selected>1 minute</option>
                            <option value="300">5 minutes</option>
                            <option value="600">10 minutes</option>
                        </select>
                    </div>
                    <button onclick="testNewRelicConnection()" class="btn-secondary">Test Connection</button>
                </div>
            </div>
            <div id="connectionStatus" class="connection-status" style="display: none;"></div>
        </section>

        <!-- Core Web Vitals Section -->
        <section class="core-web-vitals-section" id="coreWebVitalsSection" style="display: none;">
            <h2>üéØ Core Web Vitals - Live Metrics</h2>
            
            <div class="cwv-config">
                <div class="form-group">
                    <label for="cwvPageUrl">Page URL to Monitor</label>
                    <input type="text" id="cwvPageUrl" placeholder="https://www.lampsplus.com/" value="https://www.lampsplus.com/">
                </div>
                <div class="form-group">
                    <label for="cwvTimeRange">Time Range</label>
                    <select id="cwvTimeRange">
                        <option value="30 minutes ago" selected>Last 30 minutes</option>
                        <option value="1 hour ago">Last 1 hour</option>
                        <option value="3 hours ago">Last 3 hours</option>
                        <option value="6 hours ago">Last 6 hours</option>
                        <option value="12 hours ago">Last 12 hours</option>
                        <option value="24 hours ago">Last 24 hours</option>
                    </select>
                </div>
                <button onclick="loadCoreWebVitals()" class="btn-primary">Load Metrics</button>
                <button onclick="toggleAutoRefresh()" id="autoRefreshBtn" class="btn-secondary">Enable Auto-Refresh</button>
            </div>

            <div id="cwvLoadingIndicator" class="loading-indicator" style="display: none;">
                <div class="loading-spinner"></div>
                <p>Loading Core Web Vitals data from New Relic...</p>
            </div>

            <div id="cwvMetricsContainer" style="display: none;">
                <!-- Core Web Vitals Cards -->
                <div class="cwv-primary-metrics">
                    <div class="cwv-metric-card lcp-card">
                        <div class="cwv-metric-header">
                            <h3>LCP</h3>
                            <span class="cwv-metric-name">Largest Contentful Paint</span>
                            <span class="cwv-ideal-score">Ideal P75: ‚â§ 2500ms</span>
                        </div>
                        <div class="cwv-percentiles">
                            <div class="percentile-item">
                                <span class="percentile-label">P50</span>
                                <div class="percentile-value-container">
                                    <span class="percentile-value" id="lcp-p50">--</span>
                                </div>
                                <span class="percentile-unit">ms</span>
                            </div>
                            <div class="percentile-item">
                                <span class="percentile-label">P75</span>
                                <div class="percentile-value-container">
                                    <span class="percentile-value" id="lcp-p75">--</span>
                                </div>
                                <span class="percentile-unit">ms</span>
                            </div>
                            <div class="percentile-item">
                                <span class="percentile-label">P90</span>
                                <div class="percentile-value-container">
                                    <span class="percentile-value" id="lcp-p90">--</span>
                                </div>
                                <span class="percentile-unit">ms</span>
                            </div>
                        </div>
                        <div class="cwv-threshold-indicator" id="lcp-indicator"></div>
                    </div>

                    <div class="cwv-metric-card cls-card">
                        <div class="cwv-metric-header">
                            <h3>CLS</h3>
                            <span class="cwv-metric-name">Cumulative Layout Shift</span>
                            <span class="cwv-ideal-score">Ideal P75: ‚â§ 0.1</span>
                        </div>
                        <div class="cwv-percentiles">
                            <div class="percentile-item">
                                <span class="percentile-label">P50</span>
                                <div class="percentile-value-container">
                                    <span class="percentile-value" id="cls-p50">--</span>
                                </div>
                                <span class="percentile-unit">&nbsp;</span>
                            </div>
                            <div class="percentile-item">
                                <span class="percentile-label">P75</span>
                                <div class="percentile-value-container">
                                    <span class="percentile-value" id="cls-p75">--</span>
                                </div>
                                <span class="percentile-unit">&nbsp;</span>
                            </div>
                            <div class="percentile-item">
                                <span class="percentile-label">P90</span>
                                <div class="percentile-value-container">
                                    <span class="percentile-value" id="cls-p90">--</span>
                                </div>
                                <span class="percentile-unit">&nbsp;</span>
                            </div>
                        </div>
                        <div class="cwv-threshold-indicator" id="cls-indicator"></div>
                    </div>

                    <div class="cwv-metric-card pageload-card">
                        <div class="cwv-metric-header">
                            <h3>Page Load</h3>
                            <span class="cwv-metric-name">Total Page Load Time</span>
                            <span class="cwv-ideal-score">Ideal P75: ‚â§ 2000ms</span>
                        </div>
                        <div class="cwv-percentiles">
                            <div class="percentile-item">
                                <span class="percentile-label">P50</span>
                                <div class="percentile-value-container">
                                    <span class="percentile-value" id="pageLoad-p50">--</span>
                                </div>
                                <span class="percentile-unit">ms</span>
                            </div>
                            <div class="percentile-item">
                                <span class="percentile-label">P75</span>
                                <div class="percentile-value-container">
                                    <span class="percentile-value" id="pageLoad-p75">--</span>
                                </div>
                                <span class="percentile-unit">ms</span>
                            </div>
                            <div class="percentile-item">
                                <span class="percentile-label">P90</span>
                                <div class="percentile-value-container">
                                    <span class="percentile-value" id="pageLoad-p90">--</span>
                                </div>
                                <span class="percentile-unit">ms</span>
                            </div>
                        </div>
                        <div class="cwv-threshold-indicator" id="pageLoad-indicator"></div>
                    </div>
                </div>

                <!-- Performance Breakdown -->
                <div class="performance-breakdown">
                    <h3>Performance Breakdown</h3>
                    <div class="breakdown-grid">
                        <div class="breakdown-card">
                            <h4>Backend Duration</h4>
                            <p class="breakdown-ideal">Ideal P75: ‚â§ 500ms</p>
                            <div class="breakdown-values">
                                <span class="breakdown-value" id="backend-p50">--</span>
                                <span class="breakdown-value" id="backend-p75">--</span>
                                <span class="breakdown-value" id="backend-p90">--</span>
                            </div>
                        </div>
                        <div class="breakdown-card">
                            <h4>Frontend Duration</h4>
                            <p class="breakdown-ideal">Ideal P75: ‚â§ 1500ms</p>
                            <div class="breakdown-values">
                                <span class="breakdown-value" id="frontend-p50">--</span>
                                <span class="breakdown-value" id="frontend-p75">--</span>
                                <span class="breakdown-value" id="frontend-p90">--</span>
                            </div>
                        </div>
                        <div class="breakdown-card">
                            <h4>TTFB-like (Queue + Network)</h4>
                            <p class="breakdown-ideal">Ideal P75: ‚â§ 800ms</p>
                            <div class="breakdown-values">
                                <span class="breakdown-value" id="ttfbLike-p50">--</span>
                                <span class="breakdown-value" id="ttfbLike-p75">--</span>
                                <span class="breakdown-value" id="ttfbLike-p90">--</span>
                            </div>
                        </div>
                        <div class="breakdown-card">
                            <h4>DOM Processing</h4>
                            <p class="breakdown-ideal">Ideal P75: ‚â§ 500ms</p>
                            <div class="breakdown-values">
                                <span class="breakdown-value" id="domProcessing-p50">--</span>
                                <span class="breakdown-value" id="domProcessing-p75">--</span>
                                <span class="breakdown-value" id="domProcessing-p90">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Interactions Counter & Raw Results Side by Side -->
                <div class="interactions-and-raw-section">
                    <div class="interactions-side">
                        <div class="interactions-card-half">
                            <h3>Browser Interactions</h3>
                            <div class="interactions-count" id="interactionsCount">--</div>
                            <p class="interactions-note">Interactions detected in the last <span id="timeRangeDisplay">30 minutes</span></p>
                        </div>
                        
                        <!-- Metadata Display -->
                        <div class="cwv-metadata">
                            <p><strong>App Name:</strong> <span id="metaAppName">--</span></p>
                            <p><strong>Page URL:</strong> <span id="metaPageUrl">--</span></p>
                            <p><strong>Last Updated:</strong> <span id="metaLastUpdated">--</span></p>
                        </div>
                    </div>
                    
                    <div class="raw-results-card">
                        <h3>Raw Query Results</h3>
                        <pre id="rawResultsContent"></pre>
                    </div>
                </div>
            </div>
        </section>

        <!-- Quick Stats Overview -->
        <section class="stats-overview">
            <h2>üìä Performance Overview</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">‚ö°</div>
                    <div class="stat-content">
                        <div class="stat-label">Avg Response Time</div>
                        <div class="stat-value" id="avgResponseTime">-- ms</div>
                        <div class="stat-change" id="avgResponseTimeChange"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìà</div>
                    <div class="stat-content">
                        <div class="stat-label">Throughput</div>
                        <div class="stat-value" id="throughput">-- rpm</div>
                        <div class="stat-change" id="throughputChange"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚ùå</div>
                    <div class="stat-content">
                        <div class="stat-label">Error Rate</div>
                        <div class="stat-value" id="errorRate">-- %</div>
                        <div class="stat-change" id="errorRateChange"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üéØ</div>
                    <div class="stat-content">
                        <div class="stat-label">Apdex Score</div>
                        <div class="stat-value" id="apdexScore">--</div>
                        <div class="stat-change" id="apdexScoreChange"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- APM Metrics -->
        <section class="apm-section">
            <h2>üöÄ Application Performance Monitoring</h2>
            <div class="tabs">
                <button class="tab active" onclick="switchAPMTab('transactions')">Transactions</button>
                <button class="tab" onclick="switchAPMTab('database')">Database</button>
                <button class="tab" onclick="switchAPMTab('external')">External Services</button>
                <button class="tab" onclick="switchAPMTab('errors')">Errors</button>
            </div>
            
            <div id="transactions-content" class="tab-content active">
                <div class="metrics-table-container">
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Transaction Name</th>
                                <th class="sortable" onclick="sortTable(this, 1)">Avg Response Time <span class="sort-indicator">‚Üï</span></th>
                                <th class="sortable" onclick="sortTable(this, 2)">Calls/Min <span class="sort-indicator">‚Üï</span></th>
                                <th class="sortable" onclick="sortTable(this, 3)">Total Time % <span class="sort-indicator">‚Üï</span></th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsTable">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 40px; color: #9ca3af;">
                                    Configure New Relic API to load transaction data
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div id="database-content" class="tab-content">
                <div class="metrics-table-container">
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Database Operation</th>
                                <th class="sortable" onclick="sortTable(this, 1)">Avg Duration <span class="sort-indicator">‚Üï</span></th>
                                <th class="sortable" onclick="sortTable(this, 2)">Calls/Min <span class="sort-indicator">‚Üï</span></th>
                                <th class="sortable" onclick="sortTable(this, 3)">Total Time % <span class="sort-indicator">‚Üï</span></th>
                                <th>Type</th>
                            </tr>
                        </thead>
                        <tbody id="databaseTable">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 40px; color: #9ca3af;">
                                    Configure New Relic API to load database metrics
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div id="external-content" class="tab-content">
                <div class="metrics-table-container">
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>External Service</th>
                                <th class="sortable" onclick="sortTable(this, 1)">Avg Response Time <span class="sort-indicator">‚Üï</span></th>
                                <th class="sortable" onclick="sortTable(this, 2)">Calls/Min <span class="sort-indicator">‚Üï</span></th>
                                <th class="sortable" onclick="sortTable(this, 3)">Total Time % <span class="sort-indicator">‚Üï</span></th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="externalTable">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 40px; color: #9ca3af;">
                                    Configure New Relic API to load external service data
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div id="errors-content" class="tab-content">
                <div class="metrics-table-container">
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Error Type</th>
                                <th>Error Message</th>
                                <th class="sortable" onclick="sortTable(this, 2)">Count <span class="sort-indicator">‚Üï</span></th>
                                <th>Last Occurrence</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="errorsTable">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 40px; color: #9ca3af;">
                                    Configure New Relic API to load error data
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Infrastructure Metrics -->
        <section class="infrastructure-section">
            <h2>üíª Infrastructure Monitoring</h2>
            <div class="infrastructure-grid">
                <div class="infra-card">
                    <h3>CPU Usage</h3>
                    <div class="metric-display">
                        <div class="metric-value" id="cpuUsage">--%</div>
                        <div class="metric-chart">
                            <div class="mini-chart" id="cpuChart">
                                <!-- Mini sparkline chart placeholder -->
                                <div class="chart-placeholder">üìä Chart will appear here</div>
                            </div>
                        </div>
                    </div>
                    <div class="metric-status">Status: <span class="status-good">Normal</span></div>
                </div>
                
                <div class="infra-card">
                    <h3>Memory Usage</h3>
                    <div class="metric-display">
                        <div class="metric-value" id="memoryUsage">--%</div>
                        <div class="metric-chart">
                            <div class="mini-chart" id="memoryChart">
                                <div class="chart-placeholder">üìä Chart will appear here</div>
                            </div>
                        </div>
                    </div>
                    <div class="metric-status">Status: <span class="status-good">Normal</span></div>
                </div>
                
                <div class="infra-card">
                    <h3>Network I/O</h3>
                    <div class="metric-display">
                        <div class="metric-value" id="networkIO">-- MB/s</div>
                        <div class="metric-chart">
                            <div class="mini-chart" id="networkChart">
                                <div class="chart-placeholder">üìä Chart will appear here</div>
                            </div>
                        </div>
                    </div>
                    <div class="metric-status">Status: <span class="status-good">Normal</span></div>
                </div>
                
                <div class="infra-card">
                    <h3>Disk Usage</h3>
                    <div class="metric-display">
                        <div class="metric-value" id="diskUsage">--%</div>
                        <div class="metric-chart">
                            <div class="mini-chart" id="diskChart">
                                <div class="chart-placeholder">üìä Chart will appear here</div>
                            </div>
                        </div>
                    </div>
                    <div class="metric-status">Status: <span class="status-good">Normal</span></div>
                </div>
            </div>
        </section>

        <!-- Browser Metrics -->
        <section class="browser-section">
            <h2>üåê Browser Performance</h2>
            <div class="browser-grid">
                <div class="browser-metric-card">
                    <h3>Page Load Time</h3>
                    <div class="browser-metric-value" id="pageLoadTime">-- s</div>
                    <div class="browser-metric-breakdown">
                        <div class="breakdown-item">
                            <span>Network</span>
                            <span id="networkTime">-- ms</span>
                        </div>
                        <div class="breakdown-item">
                            <span>DOM Processing</span>
                            <span id="domTime">-- ms</span>
                        </div>
                        <div class="breakdown-item">
                            <span>Rendering</span>
                            <span id="renderTime">-- ms</span>
                        </div>
                    </div>
                </div>
                
                <div class="browser-metric-card">
                    <h3>AJAX Performance</h3>
                    <div class="browser-metric-value" id="ajaxTime">-- ms</div>
                    <div class="browser-metric-breakdown">
                        <div class="breakdown-item">
                            <span>Avg Duration</span>
                            <span id="ajaxAvg">-- ms</span>
                        </div>
                        <div class="breakdown-item">
                            <span>Requests/Min</span>
                            <span id="ajaxRate">--</span>
                        </div>
                        <div class="breakdown-item">
                            <span>Success Rate</span>
                            <span id="ajaxSuccess">--%</span>
                        </div>
                    </div>
                </div>
                
                <div class="browser-metric-card">
                    <h3>JavaScript Errors</h3>
                    <div class="browser-metric-value error-count" id="jsErrors">--</div>
                    <div class="browser-metric-breakdown">
                        <div class="breakdown-item">
                            <span>Last Hour</span>
                            <span id="jsErrorsHour">--</span>
                        </div>
                        <div class="breakdown-item">
                            <span>Today</span>
                            <span id="jsErrorsDay">--</span>
                        </div>
                        <div class="breakdown-item">
                            <span>This Week</span>
                            <span id="jsErrorsWeek">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Custom Queries -->
        <section class="nrql-section">
            <h2>üîç Custom NRQL Queries</h2>
            <div class="nrql-editor">
                <div class="editor-header">
                    <h3>Query Builder</h3>
                    <div class="query-actions">
                        <button onclick="loadSampleQuery('apm')" class="btn-secondary">Load APM Sample</button>
                        <button onclick="loadSampleQuery('browser')" class="btn-secondary">Load Browser Sample</button>
                        <button onclick="runNRQLQuery()" class="btn-primary">Run Query</button>
                    </div>
                </div>
                <textarea id="nrqlQuery" rows="4" placeholder="SELECT average(duration) FROM Transaction WHERE appName = 'Your App' SINCE 1 hour ago"></textarea>
                <div id="queryResults" class="query-results" style="display: none;">
                    <h4>Results</h4>
                    <div id="queryResultsContent"></div>
                </div>
            </div>
        </section>

        <!-- Alerts & Incidents -->
        <section class="alerts-section">
            <h2>üö® Recent Alerts & Incidents</h2>
            <div class="alerts-container">
                <div class="alert-item alert-warning">
                    <div class="alert-icon">‚ö†Ô∏è</div>
                    <div class="alert-content">
                        <div class="alert-title">High Response Time Detected</div>
                        <div class="alert-description">Average response time exceeded 2s threshold</div>
                        <div class="alert-meta">2 hours ago ‚Ä¢ Duration: 15 minutes</div>
                    </div>
                    <div class="alert-status">Resolved</div>
                </div>
                
                <div class="alert-item alert-critical">
                    <div class="alert-icon">üî¥</div>
                    <div class="alert-content">
                        <div class="alert-title">Database Connection Pool Exhausted</div>
                        <div class="alert-description">All database connections in use, new requests queuing</div>
                        <div class="alert-meta">5 hours ago ‚Ä¢ Duration: 8 minutes</div>
                    </div>
                    <div class="alert-status">Resolved</div>
                </div>
                
                <div class="alert-item alert-info">
                    <div class="alert-icon">‚ÑπÔ∏è</div>
                    <div class="alert-content">
                        <div class="alert-title">Deployment Completed</div>
                        <div class="alert-description">Version 2.5.0 successfully deployed to production</div>
                        <div class="alert-meta">1 day ago</div>
                    </div>
                    <div class="alert-status">Info</div>
                </div>
            </div>
        </section>
    </div>

    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script>
        // New Relic specific JavaScript
        let nrConfig = {
            apiKey: null,
            accountId: null,
            appName: null,
            refreshRate: 60
        };

        function saveNewRelicConfig() {
            nrConfig.apiKey = document.getElementById('nrApiKey').value;
            nrConfig.accountId = document.getElementById('nrAccountId').value;
            nrConfig.appName = document.getElementById('nrAppName').value;
            nrConfig.refreshRate = parseInt(document.getElementById('nrRefreshRate').value);
            
            // Save to localStorage
            localStorage.setItem('nrConfig', JSON.stringify(nrConfig));
            
            showNotification('Configuration saved successfully!', 'success');
        }

        function loadNewRelicConfig() {
            const saved = localStorage.getItem('nrConfig');
            if (saved) {
                nrConfig = JSON.parse(saved);
                document.getElementById('nrApiKey').value = nrConfig.apiKey || '';
                document.getElementById('nrAccountId').value = nrConfig.accountId || '';
                document.getElementById('nrAppName').value = nrConfig.appName || '';
                document.getElementById('nrRefreshRate').value = nrConfig.refreshRate || 60;
            }
        }

        function testNewRelicConnection() {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.style.display = 'block';
            statusDiv.className = 'connection-status testing';
            statusDiv.innerHTML = 'üîÑ Testing connection to New Relic...';
            
            if (!nrConfig.apiKey) {
                statusDiv.className = 'connection-status error';
                statusDiv.innerHTML = '‚ùå Please enter an API key first.';
                return;
            }
            
            // Call the backend API to test connection
            fetch('/api/newrelic/test-connection', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    api_key: nrConfig.apiKey
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    statusDiv.className = 'connection-status success';
                    statusDiv.innerHTML = '‚úÖ ' + data.message;
                    
                    // Show Core Web Vitals section
                    document.getElementById('coreWebVitalsSection').style.display = 'block';
                } else {
                    statusDiv.className = 'connection-status error';
                    statusDiv.innerHTML = '‚ùå ' + data.message;
                }
            })
            .catch(error => {
                statusDiv.className = 'connection-status error';
                statusDiv.innerHTML = '‚ùå Connection failed: ' + error.message;
            });
        }

        function switchAPMTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.apm-section .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + '-content').classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        function loadSampleQuery(type) {
            const queries = {
                apm: "SELECT average(duration), count(*) FROM Transaction WHERE appName = 'YourApp' FACET name SINCE 1 hour ago",
                browser: "SELECT average(pageRenderingDuration), average(domProcessingDuration) FROM PageView SINCE 1 hour ago"
            };
            
            document.getElementById('nrqlQuery').value = queries[type];
        }

        function runNRQLQuery() {
            const query = document.getElementById('nrqlQuery').value;
            const resultsDiv = document.getElementById('queryResults');
            const contentDiv = document.getElementById('queryResultsContent');
            
            if (!query.trim()) {
                showNotification('Please enter a NRQL query', 'error');
                return;
            }
            
            resultsDiv.style.display = 'block';
            contentDiv.innerHTML = '<div class="loading">Running query...</div>';
            
            // Simulate query execution (replace with actual New Relic API call)
            setTimeout(() => {
                contentDiv.innerHTML = `
                    <div class="query-result-message">
                        <p>‚ö†Ô∏è This is a demo interface. Connect your New Relic API to run actual queries.</p>
                        <p>Your query: <code>${escapeHtml(query)}</code></p>
                    </div>
                `;
            }, 1000);
        }

        function showNotification(message, type) {
            // You can implement a toast notification here
            alert(message);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Performance Overview
        async function loadPerformanceOverview() {
            if (!nrConfig.apiKey || !nrConfig.accountId || !nrConfig.appName) {
                return;
            }

            const timeRange = document.getElementById('cwvTimeRange').value;

            try {
                const response = await fetch('/api/newrelic/performance-overview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        api_key: nrConfig.apiKey,
                        account_id: parseInt(nrConfig.accountId),
                        app_name: nrConfig.appName,
                        time_range: timeRange
                    })
                });

                const data = await response.json();

                if (!response.ok || !data.success) {
                    console.error('Performance overview error:', data.error);
                    return;
                }

                const current = data.current;
                const previous = data.previous;

                // Avg Response Time (already in ms from backend)
                if (current.avgResponseTime !== null) {
                    document.getElementById('avgResponseTime').textContent = Math.round(current.avgResponseTime) + ' ms';
                    updateChangeIndicator('avgResponseTimeChange', current.avgResponseTime, previous.avgResponseTime, 'lower-better');
                }

                // Throughput (requests per minute)
                if (current.throughput !== null) {
                    document.getElementById('throughput').textContent = Number(current.throughput).toLocaleString(undefined, {maximumFractionDigits: 0}) + ' rpm';
                    updateChangeIndicator('throughputChange', current.throughput, previous.throughput, 'higher-better');
                }

                // Error Rate (percentage) - use more decimals for very small values
                if (current.errorRate !== null) {
                    const errRate = Number(current.errorRate);
                    const decimals = errRate < 0.01 ? 4 : 2;
                    document.getElementById('errorRate').textContent = errRate.toFixed(decimals) + ' %';
                    updateChangeIndicator('errorRateChange', current.errorRate, previous.errorRate, 'lower-better');
                }

                // Apdex Score
                if (current.apdex !== null) {
                    document.getElementById('apdexScore').textContent = Number(current.apdex).toFixed(2);
                    updateChangeIndicator('apdexScoreChange', current.apdex, previous.apdex, 'higher-better');
                }

            } catch (error) {
                console.error('Error loading performance overview:', error);
            }
        }

        // APM Metrics
        async function loadAPMMetrics() {
            if (!nrConfig.apiKey || !nrConfig.accountId || !nrConfig.appName) {
                return;
            }

            const timeRange = document.getElementById('cwvTimeRange').value;

            try {
                const response = await fetch('/api/newrelic/apm-metrics', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        api_key: nrConfig.apiKey,
                        account_id: parseInt(nrConfig.accountId),
                        app_name: nrConfig.appName,
                        time_range: timeRange
                    })
                });

                const data = await response.json();

                if (!response.ok || !data.success) {
                    console.error('APM metrics error:', data.error);
                    return;
                }

                populateTransactionsTable(data.transactions);
                populateDatabaseTable(data.database);
                populateExternalTable(data.external);
                populateErrorsTable(data.errors);

            } catch (error) {
                console.error('Error loading APM metrics:', error);
            }
        }

        function populateTransactionsTable(transactions) {
            const tbody = document.getElementById('transactionsTable');
            if (!transactions || transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #9ca3af;">No transaction data found for this time range</td></tr>';
                return;
            }
            tbody.innerHTML = transactions.map(t => `
                <tr>
                    <td><code>${escapeHtml(t.name)}</code></td>
                    <td>${t.avgTime} ms</td>
                    <td>${t.callsPerMin}</td>
                    <td>${t.timePercent}%</td>
                    <td><span class="score ${t.status}">${t.status === 'good' ? '‚úì Good' : (t.status === 'warning' ? '‚ö† Slow' : '‚úó Critical')}</span></td>
                </tr>
            `).join('');
        }

        function populateDatabaseTable(database) {
            const tbody = document.getElementById('databaseTable');
            if (!database || database.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #9ca3af;">No database data found for this time range</td></tr>';
                return;
            }
            tbody.innerHTML = database.map(d => `
                <tr>
                    <td><code>${escapeHtml(d.name)}</code></td>
                    <td>${d.avgDuration} ms</td>
                    <td>${d.callsPerMin}</td>
                    <td>${d.timePercent}%</td>
                    <td>${d.type}</td>
                </tr>
            `).join('');
        }

        function populateExternalTable(external) {
            const tbody = document.getElementById('externalTable');
            if (!external || external.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #9ca3af;">No external service data found for this time range</td></tr>';
                return;
            }
            tbody.innerHTML = external.map(e => `
                <tr>
                    <td><code>${escapeHtml(e.name)}</code></td>
                    <td>${e.avgTime} ms</td>
                    <td>${e.callsPerMin}</td>
                    <td>${e.timePercent}%</td>
                    <td><span class="score ${e.status}">${e.status === 'good' ? '‚úì Good' : (e.status === 'warning' ? '‚ö† Slow' : '‚úó Critical')}</span></td>
                </tr>
            `).join('');
        }

        function populateErrorsTable(errors) {
            const tbody = document.getElementById('errorsTable');
            if (!errors || errors.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #9ca3af;">No errors found for this time range üéâ</td></tr>';
                return;
            }
            tbody.innerHTML = errors.map(e => {
                const lastSeen = e.lastOccurrence ? new Date(e.lastOccurrence).toLocaleString() : '--';
                return `
                <tr>
                    <td><code>${escapeHtml(e.errorClass)}</code></td>
                    <td>${escapeHtml(e.errorMessage)}</td>
                    <td>${e.count}</td>
                    <td>${lastSeen}</td>
                    <td>-</td>
                </tr>
            `}).join('');
        }

        function updateChangeIndicator(elementId, current, previous, direction) {
            const el = document.getElementById(elementId);
            if (!el || current === null || previous === null || previous === 0) {
                if (el) el.textContent = '';
                return;
            }

            const pctChange = ((current - previous) / Math.abs(previous)) * 100;
            const absChange = Math.abs(pctChange).toFixed(1);

            let isPositive;
            if (direction === 'lower-better') {
                // For response time and error rate, going down is good
                isPositive = pctChange <= 0;
            } else {
                // For throughput and apdex, going up is good
                isPositive = pctChange >= 0;
            }

            const arrow = pctChange >= 0 ? '‚Üë' : '‚Üì';
            el.textContent = `${arrow} ${absChange}% from previous period`;
            el.className = `stat-change ${isPositive ? 'positive' : 'negative'}`;
        }

        // Core Web Vitals functionality
        let autoRefreshInterval = null;

        async function loadCoreWebVitals() {
            const pageUrl = document.getElementById('cwvPageUrl').value;
            const timeRange = document.getElementById('cwvTimeRange').value;

            if (!nrConfig.apiKey || !nrConfig.accountId || !nrConfig.appName) {
                showNotification('Please configure your New Relic API settings first', 'error');
                return;
            }

            if (!pageUrl) {
                showNotification('Please enter a page URL to monitor', 'error');
                return;
            }

            // Show loading indicator
            document.getElementById('cwvLoadingIndicator').style.display = 'block';
            document.getElementById('cwvMetricsContainer').style.display = 'none';

            try {
                const response = await fetch('/api/newrelic/core-web-vitals', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        api_key: nrConfig.apiKey,
                        account_id: parseInt(nrConfig.accountId),
                        app_name: nrConfig.appName,
                        page_url: pageUrl,
                        time_range: timeRange
                    })
                });

                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'Failed to load metrics');
                }

                // Hide loading, show metrics
                document.getElementById('cwvLoadingIndicator').style.display = 'none';
                document.getElementById('cwvMetricsContainer').style.display = 'block';
                document.getElementById('coreWebVitalsSection').style.display = 'block';

                // Populate inline raw results - show only the New Relic response data
                const rawContent = document.getElementById('rawResultsContent');
                if (rawContent && data.raw_response) {
                    const nrData = data.raw_response.data?.actor?.account || data.raw_response;
                    rawContent.textContent = JSON.stringify(nrData, null, 2);
                }

                // Populate metrics
                populateCoreWebVitals(data.metrics, data.metadata);

                // Also load Performance Overview and APM metrics
                loadPerformanceOverview();
                loadAPMMetrics();

            } catch (error) {
                document.getElementById('cwvLoadingIndicator').style.display = 'none';
                showNotification('Error loading Core Web Vitals: ' + error.message, 'error');
            }
        }

        function populateCoreWebVitals(metrics, metadata) {
            // LCP
            document.getElementById('lcp-p50').textContent = formatMetric(metrics.lcp.p50);
            document.getElementById('lcp-p75').textContent = formatMetric(metrics.lcp.p75);
            document.getElementById('lcp-p90').textContent = formatMetric(metrics.lcp.p90);
            updateThresholdIndicator('lcp-indicator', metrics.lcp.p75, 2500, 4000);

            // CLS
            document.getElementById('cls-p50').textContent = formatMetric(metrics.cls.p50, 3);
            document.getElementById('cls-p75').textContent = formatMetric(metrics.cls.p75, 3);
            document.getElementById('cls-p90').textContent = formatMetric(metrics.cls.p90, 3);
            updateThresholdIndicator('cls-indicator', metrics.cls.p75, 0.1, 0.25);

            // Page Load - New Relic returns in seconds, convert to milliseconds
            const pageLoadP50 = metrics.pageLoad.p50 ? metrics.pageLoad.p50 * 1000 : null;
            const pageLoadP75 = metrics.pageLoad.p75 ? metrics.pageLoad.p75 * 1000 : null;
            const pageLoadP90 = metrics.pageLoad.p90 ? metrics.pageLoad.p90 * 1000 : null;
            
            document.getElementById('pageLoad-p50').textContent = formatMetric(pageLoadP50);
            document.getElementById('pageLoad-p75').textContent = formatMetric(pageLoadP75);
            document.getElementById('pageLoad-p90').textContent = formatMetric(pageLoadP90);
            updateThresholdIndicator('pageLoad-indicator', pageLoadP75, 2000, 4000);

            // Breakdown metrics
            document.getElementById('backend-p50').textContent = formatMetric(metrics.backend.p50) + ' ms';
            document.getElementById('backend-p75').textContent = formatMetric(metrics.backend.p75) + ' ms';
            document.getElementById('backend-p90').textContent = formatMetric(metrics.backend.p90) + ' ms';

            document.getElementById('frontend-p50').textContent = formatMetric(metrics.frontend.p50) + ' ms';
            document.getElementById('frontend-p75').textContent = formatMetric(metrics.frontend.p75) + ' ms';
            document.getElementById('frontend-p90').textContent = formatMetric(metrics.frontend.p90) + ' ms';

            document.getElementById('ttfbLike-p50').textContent = formatMetric(metrics.ttfbLike.p50) + ' ms';
            document.getElementById('ttfbLike-p75').textContent = formatMetric(metrics.ttfbLike.p75) + ' ms';
            document.getElementById('ttfbLike-p90').textContent = formatMetric(metrics.ttfbLike.p90) + ' ms';

            document.getElementById('domProcessing-p50').textContent = formatMetric(metrics.domProcessing.p50) + ' ms';
            document.getElementById('domProcessing-p75').textContent = formatMetric(metrics.domProcessing.p75) + ' ms';
            document.getElementById('domProcessing-p90').textContent = formatMetric(metrics.domProcessing.p90) + ' ms';

            // Interactions - format with commas for readability
            const interactionsCount = metrics.interactions || 0;
            document.getElementById('interactionsCount').textContent = interactionsCount.toLocaleString();

            // Metadata
            document.getElementById('metaAppName').textContent = metadata.app_name;
            document.getElementById('metaPageUrl').textContent = metadata.page_url;
            document.getElementById('metaLastUpdated').textContent = new Date().toLocaleString();
            document.getElementById('timeRangeDisplay').textContent = metadata.time_range;
        }

        function formatMetric(value, decimals = 0) {
            if (value === null || value === undefined) {
                return '--';
            }
            return Number(value).toFixed(decimals);
        }

        function updateThresholdIndicator(elementId, value, goodThreshold, poorThreshold) {
            const indicator = document.getElementById(elementId);
            if (!value) {
                indicator.textContent = '';
                indicator.className = 'cwv-threshold-indicator';
                return;
            }

            if (value <= goodThreshold) {
                indicator.textContent = '‚úì Good';
                indicator.className = 'cwv-threshold-indicator good';
            } else if (value <= poorThreshold) {
                indicator.textContent = '‚ö† Needs Improvement';
                indicator.className = 'cwv-threshold-indicator warning';
            } else {
                indicator.textContent = '‚úó Poor';
                indicator.className = 'cwv-threshold-indicator poor';
            }
        }

        function toggleAutoRefresh() {
            const btn = document.getElementById('autoRefreshBtn');
            
            if (autoRefreshInterval) {
                // Disable auto-refresh
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                btn.textContent = 'Enable Auto-Refresh';
                btn.classList.remove('active');
            } else {
                // Enable auto-refresh (every 60 seconds)
                autoRefreshInterval = setInterval(loadCoreWebVitals, 60000);
                btn.textContent = 'Disable Auto-Refresh';
                btn.classList.add('active');
                showNotification('Auto-refresh enabled (every 60 seconds)', 'success');
            }
        }

        // Load config on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadNewRelicConfig();
        });
    </script>
</body>
</html>
