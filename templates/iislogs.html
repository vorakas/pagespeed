<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IIS Logs - PageSpeed Insights Monitor</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <!-- Side Navigation -->
    <nav class="side-nav">
        <div class="side-nav-header">
            <h2>Menu</h2>
        </div>
        <ul class="side-nav-list">
            <li><a href="/" class="side-nav-link">‚Üê Back</a></li>
            <li><a href="/setup" class="side-nav-link">Site/URL Setup</a></li>
            <li><a href="/test" class="side-nav-link">Test URLs</a></li>
            <li><a href="/metrics" class="side-nav-link">Page Performance Metrics</a></li>
            <li><a href="/newrelic" class="side-nav-link">New Relic Metrics</a></li>
            <li><a href="/iislogs" class="side-nav-link active">IIS Logs</a></li>
            <li><a href="/ai-analysis" class="side-nav-link">AI Analysis</a></li>
        </ul>
    </nav>

    <!-- Main Content Area -->
    <div class="main-content">
        <header>
            <div class="header-content">
                <div class="header-text">
                    <h1>
                        <img src="{{ url_for('static', filename='images/DarkModeLogo.png') }}" alt="Lamps Plus" class="header-logo header-logo-dark">
                        <img src="{{ url_for('static', filename='images/LightModeLogo.png') }}" alt="Lamps Plus" class="header-logo header-logo-light">
                        PageSpeed Insights Monitor
                    </h1>
                    <p>Monitor and compare website performance over time</p>
                </div>
                <button id="themeToggle" class="theme-toggle" onclick="toggleTheme()">
                    <span class="theme-icon">‚òÄÔ∏è</span>
                    <span class="theme-label">Light Mode</span>
                </button>
            </div>
        </header>

        <!-- Azure Configuration Section -->
        <section class="azure-config-section">
            <h2>Azure Log Analytics Configuration</h2>
            <div class="config-grid">
                <div class="config-card">
                    <h3>Azure AD Authentication</h3>
                    <div class="form-group">
                        <label for="azureTenantId">Tenant ID</label>
                        <input type="text" id="azureTenantId" placeholder="Enter your Directory (Tenant) ID">
                    </div>
                    <div class="form-group">
                        <label for="azureClientId">Client ID</label>
                        <input type="text" id="azureClientId" placeholder="Enter your Application (Client) ID">
                    </div>
                    <div class="form-group">
                        <label for="azureClientSecret">Client Secret</label>
                        <input type="password" id="azureClientSecret" placeholder="Enter your Client Secret Value">
                    </div>
                    <button onclick="saveAzureConfig()" class="btn-primary">Save Configuration</button>
                </div>
                <div class="config-card">
                    <h3>Workspace Settings</h3>
                    <div class="form-group">
                        <label for="azureWorkspaceId">Workspace ID</label>
                        <input type="text" id="azureWorkspaceId" placeholder="Enter your Log Analytics Workspace ID" value="25e8966e-de87-423b-bb3f-94ceed33a16b">
                    </div>
                    <div class="form-group">
                        <label for="azureSecretExpiration">Secret Expiration Date</label>
                        <input type="date" id="azureSecretExpiration">
                    </div>
                    <button onclick="testAzureConnection()" class="btn-secondary">Test Connection</button>
                </div>
            </div>
            <div id="secretExpirationWarning" class="secret-expiration-warning" style="display: none;"></div>
            <div id="azureConnectionStatus" class="connection-status" style="display: none;"></div>

            <!-- Site Selector (appears after successful connection) -->
            <div id="azureSiteSelector" class="site-selector" style="display: none;">
                <label for="azureSiteFilter">IIS Site:</label>
                <select id="azureSiteFilter" onchange="onSiteFilterChange()">
                    <option value="">All Sites</option>
                </select>
                <span id="siteLoadingIndicator" class="site-loading" style="display: none;">Loading sites...</span>
            </div>
        </section>

        <!-- Search & Filter Section -->
        <section class="iis-search-section" id="iisSearchSection" style="display: none;">
            <h2>Search & Filter IIS Logs</h2>
            <div class="search-filters">
                <div class="form-group">
                    <label for="iisStartDate">Start Date</label>
                    <input type="datetime-local" id="iisStartDate">
                </div>
                <div class="form-group">
                    <label for="iisEndDate">End Date</label>
                    <input type="datetime-local" id="iisEndDate">
                </div>
                <div class="form-group">
                    <label for="iisUrlFilter">URL Path Filter</label>
                    <input type="text" id="iisUrlFilter" placeholder="e.g. /products">
                </div>
                <div class="form-group">
                    <label for="iisStatusFilter">Status Code</label>
                    <select id="iisStatusFilter">
                        <option value="">All</option>
                        <option value="2">2xx Success</option>
                        <option value="3">3xx Redirect</option>
                        <option value="4">4xx Client Error</option>
                        <option value="5">5xx Server Error</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="iisLimit">Limit</label>
                    <select id="iisLimit">
                        <option value="50" selected>50</option>
                        <option value="100">100</option>
                        <option value="250">250</option>
                        <option value="500">500</option>
                    </select>
                </div>
                <div class="form-group" style="align-self: end;">
                    <button onclick="searchIISLogs()" class="btn-primary">Search Logs</button>
                </div>
            </div>

            <div id="iisSearchLoading" class="loading-indicator" style="display: none;">
                <div class="loading-spinner"></div>
                <p>Searching IIS logs...</p>
            </div>

            <div id="iisSearchResults" style="display: none;">
                <p class="results-count" id="iisResultsCount"></p>
                <div class="metrics-table-container">
                    <table class="results-table resizable-table" id="iisLogsResultsTable">
                        <thead>
                            <tr>
                                <th style="width: 6%">Time<div class="resize-handle"></div></th>
                                <th style="width: 3%">Method<div class="resize-handle"></div></th>
                                <th style="width: 24%">URL Path<div class="resize-handle"></div></th>
                                <th style="width: 40%">Query String<div class="resize-handle"></div></th>
                                <th style="width: 5%">Status<div class="resize-handle"></div></th>
                                <th style="width: 7%">Time Taken (ms)<div class="resize-handle"></div></th>
                                <th style="width: 7%">Client IP<div class="resize-handle"></div></th>
                                <th style="width: 8%">Site</th>
                            </tr>
                        </thead>
                        <tbody id="iisLogsTable">
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- KQL Query Mode Section -->
        <section class="kql-section" id="kqlQuerySection" style="display: none;">
            <h2>KQL Query Mode</h2>
            <div class="kql-editor">
                <div class="editor-header">
                    <h3>Query Editor</h3>
                    <div class="query-actions">
                        <select id="kqlQueryPicker" onchange="onQueryPickerChange()" class="kql-query-picker">
                            <option value="">-- Load a query --</option>
                            <optgroup label="Presets" id="kqlPresetsGroup">
                                <option value="preset:errors5xx">5xx Errors (last 1h)</option>
                                <option value="preset:slowPages">Slow Pages (last 1h)</option>
                                <option value="preset:requestVolume">Request Volume (24h)</option>
                                <option value="preset:statusDist">Status Distribution (1h)</option>
                                <option value="preset:topUrls">Top URLs (1h)</option>
                            </optgroup>
                            <optgroup label="Saved Queries" id="kqlSavedGroup">
                            </optgroup>
                        </select>
                        <input type="text" id="kqlQueryName" placeholder="Query name..." class="save-query-input">
                        <button onclick="saveKqlQuery()" class="btn-secondary save-query-btn">Save</button>
                        <button onclick="deleteSelectedQuery()" class="btn-secondary btn-danger save-query-btn" id="kqlDeleteBtn" style="display: none;">Delete</button>
                        <button onclick="runKqlQuery()" class="btn-primary">Run Query</button>
                    </div>
                </div>
                <div class="kql-query-tabs" id="kqlQueryTabs"></div>
                <textarea id="kqlQuery" rows="6" placeholder="W3CIISLog&#10;| where TimeGenerated > ago(1h)&#10;| take 100"></textarea>

                <!-- Loading Indicator -->
                <div id="kqlLoading" class="loading-indicator" style="display: none;">
                    <div class="loading-spinner"></div>
                    <p>Executing KQL query...</p>
                </div>

                <!-- Results Area -->
                <div id="kqlResults" class="query-results" style="display: none;">
                    <div class="kql-results-header">
                        <h4>Results (<span id="kqlResultCount">0</span> rows)</h4>
                        <div class="kql-results-actions">
                            <div class="kql-export-info" id="kqlExportInfo" style="display: none;">
                                <span id="kqlCsvSize" class="export-size-label"></span>
                                <button onclick="downloadKqlCsv()" class="btn-secondary export-btn">‚¨á CSV</button>
                                <button onclick="downloadKqlZip()" class="btn-secondary export-btn">‚¨á ZIP</button>
                            </div>
                            <div class="kql-results-toggle">
                                <button id="kqlTableViewBtn" onclick="switchKqlView('table')" class="btn-secondary active">Table View</button>
                                <button id="kqlJsonViewBtn" onclick="switchKqlView('json')" class="btn-secondary">Raw JSON</button>
                            </div>
                        </div>
                    </div>
                    <!-- Table View -->
                    <div id="kqlTableView" class="kql-table-view">
                        <div class="metrics-table-container">
                            <table class="results-table">
                                <thead id="kqlTableHead"></thead>
                                <tbody id="kqlTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                    <!-- JSON View -->
                    <div id="kqlJsonView" class="kql-json-view" style="display: none;">
                        <pre id="kqlJsonContent"></pre>
                    </div>
                </div>
            </div>
        </section>

        <!-- Dashboard Summary Section -->
        <section class="iis-dashboard-section" id="iisDashboardSection" style="display: none;">
            <h2>Dashboard Summary</h2>

            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-content">
                        <div class="stat-label">Total Requests</div>
                        <div class="stat-value" id="iisTotalRequests">--</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚ö†Ô∏è</div>
                    <div class="stat-content">
                        <div class="stat-label">Client Errors (4xx)</div>
                        <div class="stat-value" id="iisErrors4xx">--</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üî¥</div>
                    <div class="stat-content">
                        <div class="stat-label">Server Errors (5xx)</div>
                        <div class="stat-value" id="iisErrors5xx">--</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚ö°</div>
                    <div class="stat-content">
                        <div class="stat-label">Avg Response Time</div>
                        <div class="stat-value" id="iisAvgTime">-- ms</div>
                    </div>
                </div>
            </div>

            <!-- Response Time Breakdown -->
            <div class="breakdown-section">
                <h3>Response Time Breakdown</h3>
                <div class="breakdown-grid">
                    <div class="breakdown-item">
                        <span class="breakdown-label">P50 (Median)</span>
                        <span class="breakdown-value" id="iisP50">-- ms</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="breakdown-label">P90</span>
                        <span class="breakdown-value" id="iisP90">-- ms</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="breakdown-label">P99</span>
                        <span class="breakdown-value" id="iisP99">-- ms</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="breakdown-label">Max</span>
                        <span class="breakdown-value" id="iisMax">-- ms</span>
                    </div>
                </div>
            </div>

            <!-- Top Pages & Status Distribution side by side -->
            <div class="iis-tables-grid">
                <div>
                    <h3>Top Pages by Request Count</h3>
                    <div class="metrics-table-container">
                        <table class="results-table">
                            <thead>
                                <tr>
                                    <th>URL Path</th>
                                    <th>Requests</th>
                                    <th>Avg Time (ms)</th>
                                </tr>
                            </thead>
                            <tbody id="iisTopPagesTable">
                                <tr><td colspan="3" style="text-align: center; padding: 20px; color: #9ca3af;">No data</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div>
                    <h3>Status Code Distribution</h3>
                    <div class="metrics-table-container">
                        <table class="results-table">
                            <thead>
                                <tr>
                                    <th>Status Code</th>
                                    <th>Count</th>
                                    <th>Percentage</th>
                                </tr>
                            </thead>
                            <tbody id="iisStatusTable">
                                <tr><td colspan="3" style="text-align: center; padding: 20px; color: #9ca3af;">No data</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script>
        // Azure config object
        let azureConfig = {
            tenantId: null,
            clientId: null,
            clientSecret: null,
            workspaceId: '25e8966e-de87-423b-bb3f-94ceed33a16b',
            secretExpiration: null,
            selectedSite: null
        };

        // Timer ID for save config auto-hide (so testAzureConnection can cancel it)
        let saveConfigTimer = null;

        // Save config to localStorage
        function saveAzureConfig() {
            azureConfig.tenantId = document.getElementById('azureTenantId').value.trim();
            azureConfig.clientId = document.getElementById('azureClientId').value.trim();
            azureConfig.clientSecret = document.getElementById('azureClientSecret').value.trim();
            azureConfig.workspaceId = document.getElementById('azureWorkspaceId').value.trim();
            azureConfig.secretExpiration = document.getElementById('azureSecretExpiration').value;
            azureConfig.selectedSite = document.getElementById('azureSiteFilter').value || null;

            localStorage.setItem('azureConfig', JSON.stringify(azureConfig));
            checkSecretExpiration();

            const status = document.getElementById('azureConnectionStatus');
            status.style.display = 'block';
            status.className = 'connection-status success';
            status.textContent = 'Configuration saved.';
            saveConfigTimer = setTimeout(() => { status.style.display = 'none'; }, 3000);
        }

        // Load config from localStorage
        function loadAzureConfig() {
            const saved = localStorage.getItem('azureConfig');
            if (saved) {
                try {
                    azureConfig = JSON.parse(saved);
                    document.getElementById('azureTenantId').value = azureConfig.tenantId || '';
                    document.getElementById('azureClientId').value = azureConfig.clientId || '';
                    document.getElementById('azureClientSecret').value = azureConfig.clientSecret || '';
                    document.getElementById('azureWorkspaceId').value = azureConfig.workspaceId || '25e8966e-de87-423b-bb3f-94ceed33a16b';
                    document.getElementById('azureSecretExpiration').value = azureConfig.secretExpiration || '';
                    // selectedSite will be restored after site list loads
                } catch (e) {
                    console.error('Error loading Azure config:', e);
                }
            }
            checkSecretExpiration();
        }

        // Check and display secret expiration warning
        function checkSecretExpiration() {
            const warningEl = document.getElementById('secretExpirationWarning');
            const expDate = azureConfig.secretExpiration;

            if (!expDate) {
                warningEl.style.display = 'none';
                return;
            }

            const expiration = new Date(expDate);
            const now = new Date();
            const daysUntilExpiry = Math.ceil((expiration - now) / (1000 * 60 * 60 * 24));

            if (daysUntilExpiry <= 0) {
                warningEl.style.display = 'block';
                warningEl.className = 'secret-expiration-warning expired';
                warningEl.textContent = `CLIENT SECRET HAS EXPIRED (${expDate}). Please generate a new secret in the Azure Portal.`;
            } else if (daysUntilExpiry <= 30) {
                warningEl.style.display = 'block';
                warningEl.className = 'secret-expiration-warning warning';
                warningEl.textContent = `Client secret expires in ${daysUntilExpiry} day${daysUntilExpiry !== 1 ? 's' : ''} (${expDate}). Please plan to rotate it.`;
            } else {
                warningEl.style.display = 'none';
            }
        }

        // Test connection to Azure
        async function testAzureConnection() {
            // Save first
            saveAzureConfig();
            // Cancel the save-config auto-hide so it doesn't wipe the test result
            clearTimeout(saveConfigTimer);

            if (!azureConfig.tenantId || !azureConfig.clientId || !azureConfig.clientSecret || !azureConfig.workspaceId) {
                const status = document.getElementById('azureConnectionStatus');
                status.style.display = 'block';
                status.className = 'connection-status error';
                status.innerHTML = '<span>Please fill in all configuration fields.</span><button class="dismiss-btn" onclick="this.parentElement.style.display=\'none\'" title="Dismiss">&times;</button>';
                return;
            }

            const status = document.getElementById('azureConnectionStatus');
            status.style.display = 'block';
            status.className = 'connection-status';
            status.textContent = 'Testing connection...';

            try {
                const response = await fetch('/api/azure/test-connection', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tenant_id: azureConfig.tenantId,
                        client_id: azureConfig.clientId,
                        client_secret: azureConfig.clientSecret,
                        workspace_id: azureConfig.workspaceId
                    })
                });

                const data = await response.json();

                if (data.success) {
                    status.className = data.warning ? 'connection-status warning' : 'connection-status success';
                    status.innerHTML = `<span>${data.message}</span><button class="dismiss-btn" onclick="this.parentElement.style.display='none'" title="Dismiss">&times;</button>`;
                    // Show search and dashboard sections
                    document.getElementById('iisSearchSection').style.display = 'block';
                    document.getElementById('iisDashboardSection').style.display = 'block';
                    document.getElementById('kqlQuerySection').style.display = 'block';
                    // Show site selector and load available sites
                    document.getElementById('azureSiteSelector').style.display = 'flex';
                    loadSiteList();
                } else {
                    status.className = 'connection-status error';
                    const msg = data.message || 'Connection failed.';
                    status.innerHTML = `<span>${msg}</span><button class="dismiss-btn" onclick="this.parentElement.style.display='none'" title="Dismiss">&times;</button>`;
                }
            } catch (error) {
                status.className = 'connection-status error';
                status.innerHTML = `<span>Error testing connection: ${error.message}</span><button class="dismiss-btn" onclick="this.parentElement.style.display='none'" title="Dismiss">&times;</button>`;
            }
        }

        // Get auth payload for API calls
        function getAzureAuthPayload() {
            return {
                tenant_id: azureConfig.tenantId,
                client_id: azureConfig.clientId,
                client_secret: azureConfig.clientSecret,
                workspace_id: azureConfig.workspaceId
            };
        }

        // Load available IIS site names
        async function loadSiteList() {
            const indicator = document.getElementById('siteLoadingIndicator');
            indicator.style.display = 'inline';

            try {
                const response = await fetch('/api/azure/list-sites', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(getAzureAuthPayload())
                });

                const data = await response.json();
                indicator.style.display = 'none';

                if (data.success && data.sites && data.sites.length > 0) {
                    const select = document.getElementById('azureSiteFilter');
                    // Clear existing options (keep "All Sites")
                    select.innerHTML = '<option value="">All Sites</option>';
                    data.sites.forEach(site => {
                        const opt = document.createElement('option');
                        opt.value = site;
                        opt.textContent = site;
                        select.appendChild(opt);
                    });

                    // Restore previously selected site
                    if (azureConfig.selectedSite) {
                        select.value = azureConfig.selectedSite;
                    }
                }
            } catch (error) {
                indicator.style.display = 'none';
                console.error('Error loading site list:', error);
            }
        }

        // Handle site selector change
        function onSiteFilterChange() {
            azureConfig.selectedSite = document.getElementById('azureSiteFilter').value || null;
            localStorage.setItem('azureConfig', JSON.stringify(azureConfig));
        }

        // Get the selected site filter (for adding to queries)
        function getSelectedSite() {
            return document.getElementById('azureSiteFilter').value || null;
        }

        // Search IIS logs
        async function searchIISLogs() {
            const startDate = document.getElementById('iisStartDate').value;
            const endDate = document.getElementById('iisEndDate').value;

            if (!startDate || !endDate) {
                alert('Please select start and end dates.');
                return;
            }

            document.getElementById('iisSearchLoading').style.display = 'flex';
            document.getElementById('iisSearchResults').style.display = 'none';

            try {
                const payload = {
                    ...getAzureAuthPayload(),
                    start_date: new Date(startDate).toISOString(),
                    end_date: new Date(endDate).toISOString(),
                    url_filter: document.getElementById('iisUrlFilter').value.trim() || null,
                    status_code: document.getElementById('iisStatusFilter').value || null,
                    site_name: getSelectedSite(),
                    limit: parseInt(document.getElementById('iisLimit').value)
                };

                const response = await fetch('/api/azure/search-logs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                document.getElementById('iisSearchLoading').style.display = 'none';

                if (!response.ok || !data.success) {
                    document.getElementById('iisSearchResults').style.display = 'block';
                    document.getElementById('iisResultsCount').textContent = 'Error: ' + (data.error || 'Unknown error');
                    document.getElementById('iisLogsTable').innerHTML = '';
                    return;
                }

                document.getElementById('iisSearchResults').style.display = 'block';
                document.getElementById('iisResultsCount').textContent = `Found ${data.count} log entries`;
                populateLogsTable(data.logs);

                // Also load dashboard with same date range
                loadDashboardSummary(startDate, endDate);

            } catch (error) {
                document.getElementById('iisSearchLoading').style.display = 'none';
                console.error('Error searching logs:', error);
            }
        }

        function populateLogsTable(logs) {
            const tbody = document.getElementById('iisLogsTable');
            if (!logs || logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #9ca3af;">No log entries found for this filter</td></tr>';
                return;
            }

            tbody.innerHTML = logs.map(log => {
                const time = log.TimeGenerated ? new Date(log.TimeGenerated).toLocaleString() : '--';
                const statusClass = getStatusClass(log.scStatus);
                return `
                <tr>
                    <td class="truncate-cell" title="${time}">${time}</td>
                    <td>${log.csMethod || '--'}</td>
                    <td class="truncate-cell"><code>${escapeHtml(log.csUriStem || '--')}</code><span class="cell-full-value">${escapeHtml(log.csUriStem || '--')}</span></td>
                    <td class="wrap-cell">${escapeHtml(log.csUriQuery || '--')}</td>
                    <td><span class="${statusClass}">${log.scStatus || '--'}</span></td>
                    <td>${log.TimeTaken != null ? Number(log.TimeTaken).toLocaleString() : '--'}</td>
                    <td class="truncate-cell" title="${log.cIP || '--'}">${log.cIP || '--'}</td>
                    <td class="truncate-cell" title="${log.sSiteName || '--'}">${log.sSiteName || '--'}</td>
                </tr>`;
            }).join('');
        }

        // Dashboard summary
        async function loadDashboardSummary(startDate, endDate) {
            try {
                const payload = {
                    ...getAzureAuthPayload(),
                    start_date: new Date(startDate).toISOString(),
                    end_date: new Date(endDate).toISOString(),
                    site_name: getSelectedSite()
                };

                const response = await fetch('/api/azure/dashboard-summary', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (!response.ok || !data.success) {
                    console.error('Dashboard error:', data.error);
                    return;
                }

                populateDashboard(data);

            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        function populateDashboard(data) {
            const s = data.summary;

            // Stat cards
            document.getElementById('iisTotalRequests').textContent = Number(s.totalRequests).toLocaleString();

            const err4xx = document.getElementById('iisErrors4xx');
            err4xx.textContent = Number(s.errorCount4xx).toLocaleString();
            err4xx.style.color = s.errorCount4xx > 0 ? '#f59e0b' : '';

            const err5xx = document.getElementById('iisErrors5xx');
            err5xx.textContent = Number(s.errorCount5xx).toLocaleString();
            err5xx.style.color = s.errorCount5xx > 0 ? '#ef4444' : '';

            document.getElementById('iisAvgTime').textContent = s.avgTimeTaken + ' ms';

            // Response time breakdown
            document.getElementById('iisP50').textContent = s.p50TimeTaken + ' ms';
            document.getElementById('iisP90').textContent = s.p90TimeTaken + ' ms';
            document.getElementById('iisP99').textContent = s.p99TimeTaken + ' ms';
            document.getElementById('iisMax').textContent = Number(s.maxTimeTaken).toLocaleString() + ' ms';

            // Top pages
            const topPagesBody = document.getElementById('iisTopPagesTable');
            if (data.topPages && data.topPages.length > 0) {
                topPagesBody.innerHTML = data.topPages.map(p => `
                    <tr>
                        <td><code>${escapeHtml(p.url)}</code></td>
                        <td>${Number(p.requestCount).toLocaleString()}</td>
                        <td>${p.avgTimeTaken}</td>
                    </tr>
                `).join('');
            }

            // Status distribution
            const statusBody = document.getElementById('iisStatusTable');
            if (data.statusDistribution && data.statusDistribution.length > 0) {
                statusBody.innerHTML = data.statusDistribution.map(s => `
                    <tr>
                        <td><span class="${getStatusClass(s.statusCode)}">${s.statusCode}</span></td>
                        <td>${Number(s.count).toLocaleString()}</td>
                        <td>${s.percentage}%</td>
                    </tr>
                `).join('');
            }
        }

        // Helper: get CSS class for status code
        function getStatusClass(code) {
            if (!code) return '';
            const c = parseInt(code);
            if (c >= 500) return 'status-5xx';
            if (c >= 400) return 'status-4xx';
            if (c >= 300) return 'status-3xx';
            if (c >= 200) return 'status-2xx';
            return '';
        }

        // Helper: escape HTML
        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // ==================== KQL Query Mode ====================

        // Tab state management
        let kqlTabs = [];
        let activeKqlTabId = null;
        let kqlTabCounter = 0;

        function createKqlTab() {
            kqlTabCounter++;
            const tab = {
                id: kqlTabCounter,
                name: `Query ${kqlTabCounter}`,
                query: '',
                results: null,
                isLoading: false,
                activeView: 'table',
                pickerValue: '',
                queryName: ''
            };
            kqlTabs.push(tab);
            return tab;
        }

        function getActiveKqlTab() {
            return kqlTabs.find(t => t.id === activeKqlTabId);
        }

        function saveKqlTabState() {
            const tab = getActiveKqlTab();
            if (!tab) return;
            tab.query = document.getElementById('kqlQuery').value;
            tab.pickerValue = document.getElementById('kqlQueryPicker').value;
            tab.queryName = document.getElementById('kqlQueryName').value;
            // Save current results HTML so we can restore it
            const resultsEl = document.getElementById('kqlResults');
            if (resultsEl.style.display !== 'none') {
                tab.resultsHtml = resultsEl.innerHTML;
            }
        }

        function restoreKqlTabState(tab) {
            // Restore query text
            document.getElementById('kqlQuery').value = tab.query || '';
            document.getElementById('kqlQueryPicker').value = tab.pickerValue || '';
            document.getElementById('kqlQueryName').value = tab.queryName || '';

            // Restore delete button visibility
            const deleteBtn = document.getElementById('kqlDeleteBtn');
            deleteBtn.style.display = (tab.pickerValue && tab.pickerValue.startsWith('saved:')) ? 'inline-block' : 'none';

            // Restore loading/results state
            const loadingEl = document.getElementById('kqlLoading');
            const resultsEl = document.getElementById('kqlResults');

            if (tab.isLoading) {
                loadingEl.style.display = 'flex';
                resultsEl.style.display = 'none';
            } else if (tab.results || tab.resultsHtml) {
                loadingEl.style.display = 'none';
                resultsEl.style.display = 'block';
                if (tab.resultsHtml) {
                    resultsEl.innerHTML = tab.resultsHtml;
                } else if (tab.results) {
                    displayKqlResults(tab.results);
                }
            } else {
                loadingEl.style.display = 'none';
                resultsEl.style.display = 'none';
            }
        }

        function renderKqlTabs() {
            const container = document.getElementById('kqlQueryTabs');
            const showClose = kqlTabs.length > 1;

            let html = '';
            kqlTabs.forEach(tab => {
                const isActive = tab.id === activeKqlTabId;
                html += `<div class="kql-tab ${isActive ? 'active' : ''}" onclick="switchKqlTab(${tab.id})" ondblclick="renameKqlTab(${tab.id})">`;
                html += `<span class="kql-tab-name">${escapeHtml(tab.name)}</span>`;
                if (showClose) {
                    html += `<button class="kql-tab-close" onclick="closeKqlTab(${tab.id}, event)" title="Close tab">&times;</button>`;
                }
                html += '</div>';
            });
            html += `<button class="kql-tab-add" onclick="addKqlTab()" title="New query tab">+</button>`;
            container.innerHTML = html;
        }

        function switchKqlTab(tabId) {
            if (tabId === activeKqlTabId) return;

            // Save current tab state
            saveKqlTabState();

            // Switch to new tab
            activeKqlTabId = tabId;
            const tab = getActiveKqlTab();
            if (tab) {
                restoreKqlTabState(tab);
            }
            renderKqlTabs();
        }

        function addKqlTab() {
            // Save current tab state before creating new one
            saveKqlTabState();

            const tab = createKqlTab();
            activeKqlTabId = tab.id;
            restoreKqlTabState(tab);
            renderKqlTabs();
        }

        function closeKqlTab(tabId, event) {
            event.stopPropagation();
            if (kqlTabs.length <= 1) return;

            const tabIndex = kqlTabs.findIndex(t => t.id === tabId);
            if (tabIndex === -1) return;

            // If closing active tab, switch to adjacent tab first
            if (tabId === activeKqlTabId) {
                const nextTab = kqlTabs[tabIndex + 1] || kqlTabs[tabIndex - 1];
                activeKqlTabId = nextTab.id;
                restoreKqlTabState(nextTab);
            }

            kqlTabs.splice(tabIndex, 1);
            renderKqlTabs();
        }

        function renameKqlTab(tabId) {
            const tab = kqlTabs.find(t => t.id === tabId);
            if (!tab) return;

            const newName = prompt('Rename query tab:', tab.name);
            if (newName && newName.trim()) {
                tab.name = newName.trim();
                renderKqlTabs();
            }
        }

        const kqlSamples = {
            errors5xx: `W3CIISLog
| where TimeGenerated > ago(1h)
| where scStatus startswith "5"
| project TimeGenerated, csMethod, csUriStem, csUriQuery, scStatus, TimeTaken, cIP, sSiteName
| order by TimeGenerated desc
| take 100`,
            slowPages: `W3CIISLog
| where TimeGenerated > ago(1h)
| where TimeTaken > 5000
| project TimeGenerated, csMethod, csUriStem, scStatus, TimeTaken, cIP
| order by TimeTaken desc
| take 50`,
            requestVolume: `W3CIISLog
| where TimeGenerated > ago(24h)
| summarize RequestCount = count() by bin(TimeGenerated, 1h)
| order by TimeGenerated asc`,
            statusDist: `W3CIISLog
| where TimeGenerated > ago(1h)
| summarize Count = count() by scStatus
| order by Count desc`,
            topUrls: `W3CIISLog
| where TimeGenerated > ago(1h)
| where csUriStem !endswith ".css" and csUriStem !endswith ".js" and csUriStem !endswith ".png" and csUriStem !endswith ".jpg" and csUriStem !endswith ".ico"
| summarize Requests = count(), AvgTime = avg(TimeTaken), P95Time = percentile(TimeTaken, 95) by csUriStem
| order by Requests desc
| take 20`
        };

        function onQueryPickerChange() {
            const picker = document.getElementById('kqlQueryPicker');
            const val = picker.value;
            const deleteBtn = document.getElementById('kqlDeleteBtn');

            if (!val) {
                deleteBtn.style.display = 'none';
                return;
            }

            if (val.startsWith('preset:')) {
                const key = val.replace('preset:', '');
                if (kqlSamples[key]) {
                    document.getElementById('kqlQuery').value = kqlSamples[key];
                }
                deleteBtn.style.display = 'none';
            } else if (val.startsWith('saved:')) {
                const index = parseInt(val.replace('saved:', ''));
                const queries = getSavedKqlQueries();
                if (queries[index]) {
                    document.getElementById('kqlQuery').value = queries[index].query;
                    document.getElementById('kqlQueryName').value = queries[index].name;
                }
                deleteBtn.style.display = 'inline-block';
            }
        }

        function deleteSelectedQuery() {
            const picker = document.getElementById('kqlQueryPicker');
            const val = picker.value;
            if (!val.startsWith('saved:')) return;

            const index = parseInt(val.replace('saved:', ''));
            const queries = getSavedKqlQueries();
            if (!queries[index]) return;

            if (!confirm(`Delete saved query "${queries[index].name}"?`)) return;

            queries.splice(index, 1);
            localStorage.setItem(KQL_STORAGE_KEY, JSON.stringify(queries));
            picker.value = '';
            document.getElementById('kqlDeleteBtn').style.display = 'none';
            document.getElementById('kqlQueryName').value = '';
            renderSavedKqlQueries();
        }

        async function runKqlQuery() {
            const query = document.getElementById('kqlQuery').value.trim();
            if (!query) {
                alert('Please enter a KQL query.');
                return;
            }

            if (!azureConfig.tenantId || !azureConfig.clientId || !azureConfig.clientSecret || !azureConfig.workspaceId) {
                alert('Please configure Azure credentials first.');
                return;
            }

            const tab = getActiveKqlTab();
            const tabId = tab.id;
            tab.isLoading = true;
            tab.results = null;
            tab.resultsHtml = null;

            document.getElementById('kqlLoading').style.display = 'flex';
            document.getElementById('kqlResults').style.display = 'none';

            try {
                const payload = {
                    ...getAzureAuthPayload(),
                    query: query
                };

                const response = await fetch('/api/azure/execute-query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                // Find the tab that initiated this query (it may no longer be active)
                const originTab = kqlTabs.find(t => t.id === tabId);
                if (originTab) {
                    originTab.isLoading = false;
                }

                // Only update DOM if this tab is still the active one
                if (activeKqlTabId !== tabId) {
                    // Tab was switched away ‚Äî store results silently
                    if (originTab) {
                        if (!response.ok || !data.success) {
                            originTab.results = data;
                        } else {
                            originTab.results = data;
                        }
                    }
                    return;
                }

                document.getElementById('kqlLoading').style.display = 'none';

                if (!response.ok || !data.success) {
                    document.getElementById('kqlResults').style.display = 'block';
                    document.getElementById('kqlResultCount').textContent = '0';
                    document.getElementById('kqlTableHead').innerHTML = '';
                    document.getElementById('kqlTableBody').innerHTML =
                        `<tr><td style="color: #ef4444; padding: 20px;">Error: ${escapeHtml(data.error || 'Unknown error')}</td></tr>`;
                    document.getElementById('kqlJsonContent').textContent = JSON.stringify(data, null, 2);
                    document.getElementById('kqlExportInfo').style.display = 'none';
                    if (originTab) originTab.results = data;
                    return;
                }

                displayKqlResults(data);

            } catch (error) {
                const originTab = kqlTabs.find(t => t.id === tabId);
                if (originTab) originTab.isLoading = false;

                if (activeKqlTabId === tabId) {
                    document.getElementById('kqlLoading').style.display = 'none';
                    alert('Error executing query: ' + error.message);
                }
            }
        }

        function displayKqlResults(data) {
            const tab = getActiveKqlTab();
            if (tab) tab.results = data;
            document.getElementById('kqlResults').style.display = 'block';
            document.getElementById('kqlResultCount').textContent = data.count;

            // Show export info with estimated CSV size
            if (data.rows && data.rows.length > 0 && data.columns && data.columns.length > 0) {
                const csvContent = buildCsvContent(data.columns, data.rows);
                const sizeBytes = new Blob([csvContent]).size;
                document.getElementById('kqlCsvSize').textContent = formatFileSize(sizeBytes);
                document.getElementById('kqlExportInfo').style.display = 'flex';
            } else {
                document.getElementById('kqlExportInfo').style.display = 'none';
            }

            // Build dynamic table header from columns
            const thead = document.getElementById('kqlTableHead');
            if (data.columns && data.columns.length > 0) {
                thead.innerHTML = '<tr>' + data.columns.map(col => `<th>${escapeHtml(col)}</th>`).join('') + '</tr>';
            } else {
                thead.innerHTML = '';
            }

            // Build table body
            const tbody = document.getElementById('kqlTableBody');
            if (!data.rows || data.rows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="' + (data.columns ? data.columns.length : 1) + '" style="text-align: center; padding: 40px; color: #9ca3af;">No results returned</td></tr>';
            } else {
                tbody.innerHTML = data.rows.map(row => {
                    return '<tr>' + data.columns.map(col => {
                        let val = row[col];
                        // Format dates
                        if (col === 'TimeGenerated' && val) {
                            val = new Date(val).toLocaleString();
                        }
                        // Format numbers
                        if (typeof val === 'number') {
                            val = Number(val).toLocaleString(undefined, { maximumFractionDigits: 2 });
                        }
                        // Status code coloring
                        if (col === 'scStatus' && val) {
                            const statusClass = getStatusClass(val);
                            return `<td><span class="${statusClass}">${escapeHtml(String(val))}</span></td>`;
                        }
                        return `<td>${escapeHtml(String(val ?? '--'))}</td>`;
                    }).join('') + '</tr>';
                }).join('');
            }

            // Populate raw JSON view
            document.getElementById('kqlJsonContent').textContent = JSON.stringify(data.raw, null, 2);

            // Ensure table view is shown by default
            switchKqlView('table');
        }

        function switchKqlView(view) {
            const tab = getActiveKqlTab();
            if (tab) tab.activeView = view;

            const tableView = document.getElementById('kqlTableView');
            const jsonView = document.getElementById('kqlJsonView');
            const tableBtn = document.getElementById('kqlTableViewBtn');
            const jsonBtn = document.getElementById('kqlJsonViewBtn');

            if (view === 'table') {
                tableView.style.display = 'block';
                jsonView.style.display = 'none';
                tableBtn.classList.add('active');
                jsonBtn.classList.remove('active');
            } else {
                tableView.style.display = 'none';
                jsonView.style.display = 'block';
                tableBtn.classList.remove('active');
                jsonBtn.classList.add('active');
            }
        }

        // ==================== CSV / ZIP Export ====================

        function buildCsvContent(columns, rows) {
            // Escape CSV field: wrap in quotes if it contains comma, quote, or newline
            const escCsv = (val) => {
                if (val == null) return '';
                const str = String(val);
                if (str.includes(',') || str.includes('"') || str.includes('\n') || str.includes('\r')) {
                    return '"' + str.replace(/"/g, '""') + '"';
                }
                return str;
            };

            const header = columns.map(escCsv).join(',');
            const body = rows.map(row =>
                columns.map(col => escCsv(row[col] ?? '')).join(',')
            ).join('\n');

            return header + '\n' + body;
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function downloadKqlCsv() {
            const tab = getActiveKqlTab();
            const tabResult = tab ? tab.results : null;
            if (!tabResult || !tabResult.rows || !tabResult.columns) return;

            const csv = buildCsvContent(tabResult.columns, tabResult.rows);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = 'kql-results-' + new Date().toISOString().slice(0, 19).replace(/[T:]/g, '-') + '.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function downloadKqlZip() {
            const tab = getActiveKqlTab();
            const tabResult = tab ? tab.results : null;
            if (!tabResult || !tabResult.rows || !tabResult.columns) return;

            const csv = buildCsvContent(tabResult.columns, tabResult.rows);
            const timestamp = new Date().toISOString().slice(0, 19).replace(/[T:]/g, '-');
            const csvFilename = 'kql-results-' + timestamp + '.csv';

            const zip = new JSZip();
            zip.file(csvFilename, csv);

            const blob = await zip.generateAsync({ type: 'blob', compression: 'DEFLATE', compressionOptions: { level: 9 } });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = 'kql-results-' + timestamp + '.zip';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ==================== Saved Queries ====================

        const KQL_STORAGE_KEY = 'kqlSavedQueries';

        function getSavedKqlQueries() {
            try {
                return JSON.parse(localStorage.getItem(KQL_STORAGE_KEY)) || [];
            } catch (e) {
                return [];
            }
        }

        function saveKqlQuery() {
            const name = document.getElementById('kqlQueryName').value.trim();
            const query = document.getElementById('kqlQuery').value.trim();

            if (!name) {
                alert('Please enter a name for this query.');
                return;
            }
            if (!query) {
                alert('Please enter a KQL query to save.');
                return;
            }

            const queries = getSavedKqlQueries();
            const existingIndex = queries.findIndex(q => q.name === name);
            if (existingIndex >= 0) {
                if (!confirm(`A query named "${name}" already exists. Overwrite it?`)) {
                    return;
                }
                queries[existingIndex].query = query;
            } else {
                queries.push({ name: name, query: query });
            }

            localStorage.setItem(KQL_STORAGE_KEY, JSON.stringify(queries));
            document.getElementById('kqlQueryName').value = '';
            renderSavedKqlQueries();

            // Select the newly saved query in the picker
            const newIndex = queries.findIndex(q => q.name === name);
            document.getElementById('kqlQueryPicker').value = `saved:${newIndex}`;
            document.getElementById('kqlDeleteBtn').style.display = 'inline-block';
        }

        function renderSavedKqlQueries() {
            const group = document.getElementById('kqlSavedGroup');
            const queries = getSavedKqlQueries();

            if (queries.length === 0) {
                group.innerHTML = '<option value="" disabled>No saved queries</option>';
                return;
            }

            group.innerHTML = queries.map((q, i) =>
                `<option value="saved:${i}">${escapeHtml(q.name)}</option>`
            ).join('');
        }

        // Set default date range (last 24 hours)
        function setDefaultDateRange() {
            const now = new Date();
            const yesterday = new Date(now - 24 * 60 * 60 * 1000);

            // Format for datetime-local input (YYYY-MM-DDThh:mm)
            const formatDate = (d) => {
                return d.getFullYear() + '-' +
                    String(d.getMonth() + 1).padStart(2, '0') + '-' +
                    String(d.getDate()).padStart(2, '0') + 'T' +
                    String(d.getHours()).padStart(2, '0') + ':' +
                    String(d.getMinutes()).padStart(2, '0');
            };

            document.getElementById('iisStartDate').value = formatDate(yesterday);
            document.getElementById('iisEndDate').value = formatDate(now);
        }

        // ==================== Resizable Table Columns ====================

        function initColumnResize() {
            const table = document.getElementById('iisLogsResultsTable');
            if (!table) return;

            const handles = table.querySelectorAll('.resize-handle');
            let columnsConverted = false;

            // Convert all percentage widths to pixel widths so resizing works with table-layout: fixed
            function convertToPixelWidths() {
                if (columnsConverted) return;
                const ths = table.querySelectorAll('thead th');
                ths.forEach(th => {
                    th.style.width = th.offsetWidth + 'px';
                });
                columnsConverted = true;
            }

            handles.forEach(handle => {
                handle.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    e.stopPropagation();

                    convertToPixelWidths();

                    const th = handle.parentElement;
                    const ths = Array.from(table.querySelectorAll('thead th'));
                    const colIndex = ths.indexOf(th);
                    const nextTh = ths[colIndex + 1] || null;

                    const startX = e.pageX;
                    const startWidth = th.offsetWidth;
                    const nextStartWidth = nextTh ? nextTh.offsetWidth : 0;
                    const minWidth = 40;

                    handle.classList.add('active');
                    table.classList.add('resizing');

                    function onMouseMove(e) {
                        const delta = e.pageX - startX;
                        const newWidth = Math.max(minWidth, startWidth + delta);
                        const actualDelta = newWidth - startWidth;

                        // Resize this column
                        th.style.width = newWidth + 'px';

                        // Compensate by adjusting the next column (keeps total width stable)
                        if (nextTh) {
                            const nextWidth = Math.max(minWidth, nextStartWidth - actualDelta);
                            nextTh.style.width = nextWidth + 'px';
                        }
                    }

                    function onMouseUp() {
                        handle.classList.remove('active');
                        table.classList.remove('resizing');
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                    }

                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                });

                // Double-click to reset all columns to default percentages
                handle.addEventListener('dblclick', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const ths = table.querySelectorAll('thead th');
                    const defaults = ['6%', '3%', '24%', '40%', '5%', '7%', '7%', '8%'];
                    ths.forEach((th, i) => {
                        if (defaults[i]) th.style.width = defaults[i];
                    });
                    columnsConverted = false;
                });
            });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadAzureConfig();
            setDefaultDateRange();
            renderSavedKqlQueries();
            initColumnResize();

            // Initialize KQL query tabs with one default tab
            const initialTab = createKqlTab();
            activeKqlTabId = initialTab.id;
            renderKqlTabs();
        });
    </script>
</body>
</html>
